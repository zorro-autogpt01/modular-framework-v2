<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LLM Workflows + Gateway</title>
  <link rel="stylesheet" href="./css/theme.css">
  <link rel="stylesheet" href="./css/workflows.css">
</head>
<body>
  <div class="header">
    <strong>üõ†Ô∏è LLM Workflows</strong>
    <span class="muted">Gateway-integrated workflow builder with telemetry, templates, and cost tracking</span>
    <div class="grow"></div>
    <span id="tokenStatus" class="pill">auth: missing</span>
    <button class="ghost" id="setTokenBtn" title="Set Internal API token">üîë Token</button>
    <button class="ghost" id="newWfBtn" title="New workflow">New</button>
    <button id="saveWfBtn" title="Save workflow">Save</button>
    <button class="danger" id="deleteWfBtn" title="Delete workflow">Delete</button>
    <button class="ghost" onclick="window.location.href='./debug.html'" title="View debug logs">üîç Debug</button>
  </div>

  <div class="tabs">
    <button class="tab-btn active" id="tabBtnBuilder">Builder</button>
    <button class="tab-btn" id="tabBtnRuns">Runs</button>
    <button class="tab-btn" id="tabBtnTelemetry">Gateway Telemetry</button>
    <button class="tab-btn" id="tabBtnTemplates">Templates</button>
    <div class="grow"></div>
    <button class="ghost" id="runWfBtn" title="Run current workflow">‚ñ∂ Run</button>
  </div>

  <!-- Builder Tab -->
  <section id="tab-builder" class="pane">
    <div class="wf-wrap">
      <div class="wf-panel">
        <h3>Workflows</h3>
        <div id="wfList" class="list"></div>
        <hr style="margin:16px 0">
        <h4>Run Variables</h4>
        <label>JSON vars for testing</label>
        <textarea id="varsInput" rows="8" placeholder='{"task":"..."}'></textarea>
      </div>

      <div class="wf-panel">
        <div class="wf-head">
          <input id="wfName" placeholder="Workflow name" style="flex:1" />
          <select id="modelSelect" style="width:200px"></select>
          <button class="ghost" id="refreshModelsBtn" title="Refresh">‚Üª</button>
        </div>
        <input id="model" type="hidden" />
        <div id="modelInfo" class="muted small"></div>

        <label>Description</label>
        <textarea id="wfDesc" rows="2"></textarea>

        <div class="wf-row">
          <div>
            <label>Provider</label>
            <select id="provider">
              <option value="openai">OpenAI</option>
              <option value="openai-compatible">Compatible</option>
              <option value="ollama">Ollama</option>
            </select>
          </div>
          <div>
            <label>Base URL</label>
            <input id="baseUrl" placeholder="(from model)" />
          </div>
        </div>

        <div class="wf-row">
          <div>
            <label>API Key</label>
            <input id="apiKey" type="password" placeholder="(optional)" />
          </div>
          <div>
            <label>Temp ¬∑ Max tokens</label>
            <div class="horz">
              <input id="temperature" type="number" step="0.1" placeholder="0.2" style="width:80px" />
              <input id="max_tokens" type="number" placeholder="(auto)" style="width:80px" />
            </div>
          </div>
        </div>

        <label>Defaults (JSON)</label>
        <textarea id="defaults" rows="4" placeholder='{}'></textarea>

        <hr style="margin:16px 0">
        
        <div class="wf-head">
          <h3 style="margin:0">Steps</h3>
          <div class="grow"></div>
          <button class="ghost" id="addStepBtn">+ Add Step</button>
        </div>
        <div id="stepsList" class="wf-steps"></div>
      </div>

      <div class="wf-panel">
        <div id="noStepHint">
          <p class="muted">Select a step to edit</p>
        </div>

        <div id="stepEditor" style="display:none">
          <h3>Edit Step</h3>

          <div class="wf-row">
            <div>
              <label>Step Name</label>
              <input id="stepName" />
            </div>
            <div>
              <label>Step Type</label>
              <select id="stepType">
                <option value="llm">LLM</option>
                <option value="repoops">RepoOps</option>
              </select>
            </div>
          </div>

          <!-- LLM-only fields -->
          <div class="llm-only">
            <label>Prompt Template</label>
            <textarea id="stepPrompt" rows="6" placeholder="Use {{var}}"></textarea>

            <label>JSON Schema</label>
            <textarea id="stepSchema" rows="8"></textarea>

            <div class="wf-row">
              <label><input type="checkbox" id="stepNoGuard" /> Disable system guard</label>
              <label><input type="checkbox" id="stepDontStop" /> Don't stop on failure</label>
            </div>
          </div>

          <!-- RepoOps block -->
          <div id="repoOpsEditor" style="display:none">
            <h3>RepoOps Configuration</h3>
            
            <!-- Repository -->
            <div class="wf-row">
              <div>
                <label>GitHub Connection</label>
                <div class="horz">
                  <select id="repoOpsConnId" style="flex:1"></select>
                  <button class="ghost" id="refreshConnBtn" title="Refresh connections & branches">‚Üª</button>
                  <button class="ghost" id="testConnBtn" title="Test connection">üîó</button>
                </div>
              </div>
              <div>
                <label>Base Branch</label>
                <!-- CHANGED: now a real select -->
                <select id="repoOpsBaseBranch"></select>
              </div>
            </div>

            <div class="wf-row">
              <div>
                <label>Feature Branch <small>(templatable)</small></label>
                <input id="repoOpsHeadBranch" placeholder="feature/{{feature_name}}" />
              </div>
              <div>
                <label>Language Hints <small>(comma-separated)</small></label>
                <input id="repoOpsLanguageHints" placeholder="ts,tsx,js" />
              </div>
            </div>

            <!-- Change Request -->
            <label>Change Request <small>(supports {{vars}})</small></label>
            <textarea id="repoOpsChangeRequest" rows="4" 
              placeholder="Add a new API endpoint /api/health that returns status and version..."></textarea>

            <!-- Path Filters -->
            <details style="margin: 12px 0">
              <summary>Path Filters & Guardrails</summary>
              <div style="margin-top: 8px">
                <label>Allowed Paths (glob patterns)</label>
                <textarea id="repoOpsAllowPaths" rows="2" 
                  placeholder="src/**&#10;tests/**&#10;docs/**"></textarea>
                
                <label>Denied Paths (glob patterns)</label>
                <textarea id="repoOpsDenyPaths" rows="2" 
                  placeholder="**/*.png&#10;dist/**&#10;node_modules/**"></textarea>
              </div>
            </details>

            <!-- LLM Settings -->
            <details style="margin: 12px 0">
              <summary>LLM Settings</summary>
              <div class="wf-row" style="margin-top: 8px">
                <div>
                  <label>Model</label>
                  <input id="repoOpsModel" placeholder="gpt-4o-mini" />
                </div>
                <div>
                  <label>Temperature</label>
                  <input id="repoOpsTemperature" type="number" step="0.1" value="0.2" style="width:80px" />
                </div>
              </div>
            </details>

            <!-- Testing -->
            <details style="margin: 12px 0">
              <summary>Testing Configuration</summary>
              <div style="margin-top: 8px">
                <label>
                  <input type="checkbox" id="repoOpsTestEnabled" />
                  Enable Testing
                </label>

                <div id="repoOpsTestSettings" style="margin-top: 8px; display:none">
                  <label>Runner <span id="runnerStatusBadge" class="badge" style="margin-left:8px"></span></label>
                  <select id="repoOpsTestRunner"></select>
                  
                  <label>Test Commands (one per line)</label>
                  <textarea id="repoOpsTestCommands" rows="3" 
                    placeholder="npm ci&#10;npm test"></textarea>
                  
                  <label>Timeout (ms)</label>
                  <input id="repoOpsTestTimeout" type="number" value="900000" />
                </div>
              </div>
            </details>

            <!-- PR Options -->
            <details style="margin: 12px 0">
              <summary>Pull Request Options</summary>
              <div style="margin-top: 8px">
                <label>
                  <input type="checkbox" id="repoOpsOpenPR" />
                  Open Pull Request
                </label>
                
                <label>
                  <input type="checkbox" id="repoOpsPRDraft" />
                  Create as Draft
                </label>
              </div>
            </details>

            <!-- Approval & Exports -->
            <details style="margin: 12px 0">
              <summary>Advanced Options</summary>
              <div style="margin-top: 8px">
                <label>
                  <input type="checkbox" id="repoOpsRequireApproval" />
                  Require Manual Approval
                </label>
                
                <label>Export PR URL as</label>
                <input id="repoOpsExportPRAs" placeholder="pr_url" />
                
                <label>Export Branch Name as</label>
                <input id="repoOpsExportBranchAs" placeholder="feature_branch" />
              </div>
            </details>

            <div class="wf-actions" style="margin-top: 16px">
              <button id="repoOpsPlanBtn" class="ghost">üìã Plan Only</button>
              <button id="repoOpsTestStepBtn" class="ghost">üß™ Full Test</button>
            </div>

            <div id="repoOpsTestOutput" style="margin-top: 12px"></div>
          </div>

          <div class="wf-row">
            <div>
              <label>Export path</label>
              <input id="stepExportPath" placeholder="e.g. actions.0.content" />
            </div>
            <div>
              <label>Export as</label>
              <input id="stepExportAs" placeholder="variable name" />
            </div>
          </div>

          <details style="margin:12px 0">
            <summary>Step Overrides</summary>
            <div class="wf-row" style="margin-top:8px">
              <div>
                <label>Provider</label>
                <input id="sProvider" placeholder="(inherit)" />
              </div>
              <div>
                <label>Base URL</label>
                <input id="sBaseUrl" placeholder="(inherit)" />
              </div>
            </div>
            <div class="wf-row">
              <div>
                <label>API Key</label>
                <input id="sApiKey" type="password" placeholder="(inherit)" />
              </div>
              <div>
                <label>Temperature</label>
                <input id="sTemp" type="number" step="0.1" placeholder="(inherit)" />
              </div>
            </div>
            <div class="wf-row">
              <div>
                <label>Model</label>
                <div class="horz">
                  <select id="sModelSelect" style="flex:1"></select>
                  <button class="ghost" id="refreshModelsBtn2">‚Üª</button>
                </div>
                <input id="sModel" type="hidden" />
                <div id="sModelInfo" class="muted small"></div>
              </div>
              <div>
                <label>Runner Target <span id="stepRunnerBadge" class="badge" style="margin-left:8px"></span></label>
                <div class="horz">
                  <select id="sTarget" style="flex:1"></select>
                  <button class="ghost" id="refreshRunnersBtn">‚Üª</button>
                </div>
                <div id="sTargetInfo" class="muted small"></div>
              </div>
            </div>
          </details>

          <div class="wf-actions">
            <button class="ghost" id="testStepBtn" title="Test this step">üß™ Test Step</button>
            <label style="display:inline-flex;gap:4px;align-items:center;margin-left:8px">
              <input type="checkbox" id="execInTest" />
              Execute actions
            </label>
            <button class="ghost" id="dryRunBtn" title="Dry-run validation only">üîç Dry Run</button>
          </div>

          <div id="testOutput" style="margin-top:12px"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Runs Tab -->
  <section id="tab-runs" class="pane" style="display:none">
    <div class="grid" style="grid-template-columns: 380px 1fr">
      <div class="card">
        <h3>Run History</h3>
        <div id="runsList" class="list"></div>
      </div>
      <div>
        <div id="runDetail"></div>
      </div>
    </div>
  </section>

  <!-- Gateway Telemetry Tab -->
  <section id="tab-telemetry" class="pane" style="display:none">
    <div class="card">
      <div class="horz" style="margin-bottom:12px">
        <h3 style="margin:0">Gateway Telemetry</h3>
        <div class="grow"></div>
        <button class="ghost" id="refreshTelemetryBtn">‚Üª Refresh</button>
      </div>
      <div id="telemetryList"></div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>Workflow Cost Analysis</h3>
      <div class="horz" style="margin-bottom:12px">
        <select id="costWorkflowSelect" style="flex:1"></select>
        <button class="ghost" id="loadCostBtn">Load Cost Data</button>
      </div>
      <div id="costReport"></div>
    </div>
  </section>

  <!-- Templates Tab -->
  <section id="tab-templates" class="pane" style="display:none">
    <div class="card">
      <div class="horz" style="margin-bottom:12px">
        <h3 style="margin:0">Gateway Templates</h3>
        <div class="grow"></div>
        <button class="ghost" id="refreshTemplatesBtn">‚Üª Refresh</button>
      </div>
      <div id="templatesList"></div>
    </div>
  </section>

  <style>
  /* RepoOps-specific styles */
  #repoOpsEditor details {
    background: #1a1a1a;
    border: 1px solid #3e3e42;
    border-radius: 6px;
    padding: 8px;
  }
  #repoOpsEditor details summary {
    cursor: pointer;
    font-weight: 600;
    padding: 4px;
  }
  #repoOpsEditor details[open] summary {
    border-bottom: 1px solid #3e3e42;
    margin-bottom: 8px;
    padding-bottom: 8px;
  }
  #repoOpsTestOutput .card {
    background: #1a1a1a;
    margin-top: 8px;
  }
  #repoOpsTestOutput .error {
    background: #3a1a1a;
    border: 1px solid #a1260d;
    border-radius: 6px;
    padding: 8px;
    color: #f48771;
  }
  .badge.healthy { background: #2d7d46; }
  .badge.unhealthy { background: #a1260d; }
  .badge.unknown { background: #5a5a5a; }
  </style>

  <script>
/* =========================
   Core app state & helpers
   ========================= */
const state = {
  workflows: [],
  current: null,
  currentStepIdx: -1,
  runs: [],
  models: [],
  templates: [],
  runners: []
};

const REPOOPS_BASE = '/api/repoops';

const INTERNAL_TOKEN_KEY = 'internal_api_token';
function authHeaders(h = {}) {
  const t = localStorage.getItem(INTERNAL_TOKEN_KEY);
  return t ? { ...h, Authorization: `Bearer ${t}` } : h;
}

const $ = (id) => document.getElementById(id);
function toast(m) { alert(m); }
function fmtJson(v) { try { return JSON.stringify(v, null, 2); } catch { return String(v); } }
function parseJson(text, fallback = null) { try { return JSON.parse(text); } catch { return fallback; } }
function escapeHtml(s) {
  return String(s || '')
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function updateTokenUi() {
  const el = $('tokenStatus');
  if (!el) return;
  const has = !!localStorage.getItem(INTERNAL_TOKEN_KEY);
  el.textContent = has ? 'auth: ok' : 'auth: missing';
  el.style.background = has ? '#0e639c' : '#3e3e42';
}

function promptSetToken() {
  const cur = localStorage.getItem(INTERNAL_TOKEN_KEY) || '';
  const next = prompt('Enter INTERNAL_API_TOKEN:', cur);
  if (next != null) {
    if (next.trim()) localStorage.setItem(INTERNAL_TOKEN_KEY, next.trim());
    else localStorage.removeItem(INTERNAL_TOKEN_KEY);
  }
  updateTokenUi();
}

// Template helpers
function renderTemplate(tpl, vars) {
  return (tpl || '').replace(/\{\{\s*([\w.\-]+)\s*\}\}/g, (_m, k) => {
    const parts = String(k).split('.');
    let cur = vars || {};
    for (const p of parts) {
      if (cur && typeof cur === 'object' && p in cur) cur = cur[p];
      else return '';
    }
    return (cur === undefined || cur === null) ? '' : String(cur);
  });
}

function buildSystemGuard(schema) {
  const schemaStr = typeof schema === 'string' ? schema : JSON.stringify(schema || {}, null, 2);
  return [
    'You are a controller that MUST return a single JSON object and nothing else.',
    'Rules:',
    '- Do NOT include explanations, markdown, or code fences.',
    '- Output MUST be valid JSON that matches the schema exactly.',
    'JSON Schema:',
    schemaStr
  ].join('\n');
}

/* =========================
   Gateway models
   ========================= */
async function fetchGatewayModels() {
  try {
    const r = await fetch('./api/llm-models', { credentials: 'include' });
    const data = await r.json();
    state.models = data.items || [];
  } catch (e) {
    console.warn('Failed to load models:', e);
    state.models = [];
  }
  populateModelSelects();
  populateCostWorkflowSelect();
}

function modelOptionLabel(m) {
  const name = m.display_name || m.model_name;
  const prov = m.provider_name || m.provider_kind || '';
  const cost = (m.input_cost_per_million || m.output_cost_per_million) 
    ? ` ¬∑ ${m.input_cost_per_million || 0}/${m.output_cost_per_million || 0}` 
    : '';
  return `${name} ¬∑ ${prov}${cost}`;
}

function populateModelSelect(selectEl, infoEl, currentValue) {
  if (!selectEl) return;
  selectEl.innerHTML = '';

  const def = document.createElement('option');
  def.value = '';
  def.textContent = state.models.length ? '-- Select model --' : '-- No models (click ‚Üª) --';
  selectEl.appendChild(def);

  for (const m of state.models) {
    const opt = document.createElement('option');
    opt.value = m.model_name;
    opt.textContent = modelOptionLabel(m);
    opt.dataset.provider = m.provider_kind || '';
    opt.dataset.baseUrl = m.provider_base_url || '';
    selectEl.appendChild(opt);
  }
  
  const val = String(currentValue || '');
  const found = Array.from(selectEl.options).find(o => o.value === val);
  selectEl.value = found ? val : '';
  
  if (infoEl && found) {
    const m = state.models.find(x => x.model_name === val);
    infoEl.textContent = m ? `Provider: ${m.provider_kind} ¬∑ Base: ${m.provider_base_url}` : '';
  }
}

function populateModelSelects() {
  populateModelSelect($('modelSelect'), $('modelInfo'), $('model')?.value);
  populateModelSelect($('sModelSelect'), $('sModelInfo'), $('sModel')?.value);
}

function onModelSelectChanged(isStep = false) {
  const select = isStep ? $('sModelSelect') : $('modelSelect');
  const input = isStep ? $('sModel') : $('model');
  const provEl = isStep ? $('sProvider') : $('provider');
  const baseEl = isStep ? $('sBaseUrl') : $('baseUrl');
  const infoEl = isStep ? $('sModelInfo') : $('modelInfo');

  const val = select.value;
  input.value = val || '';
  const opt = select.selectedOptions?.[0];
  const prov = opt?.dataset?.provider || '';
  const base = opt?.dataset?.baseUrl || '';

  if (!isStep) {
    if (prov) provEl.value = prov;
    if (base && (!baseEl.value || baseEl.value === '')) baseEl.value = base;
  } else {
    if (prov && (!provEl.value || provEl.value === '')) provEl.value = prov;
    if (base && (!baseEl.value || baseEl.value === '')) baseEl.value = base;
  }
  if (infoEl) infoEl.textContent = val ? `${prov} ¬∑ ${base}` : '';
}

/* =========================
   Runners
   ========================= */
async function fetchRunners() {
  try {
    const r = await fetch('./api/runners', { headers: authHeaders() });
    const data = await r.json();
    state.runners = data.runners || [];
    
    // Health check runners
    for (const runner of state.runners) {
      try {
        const base = (runner && runner.url) ? runner.url : '';
        if (!base) throw new Error('No runner URL');
        const absBase = base.startsWith('http')
          ? base
          : `${window.location.origin}${base.startsWith('/') ? '' : '/'}${base}`;
        const healthUrl = `${absBase.replace(/\/$/, '')}/health`;
        const health = await fetch(healthUrl, { 
          signal: AbortSignal.timeout(5000) 
        });
        runner.healthy = health.ok;
      } catch {
        runner.healthy = false;
      }
    }
  } catch {
    state.runners = [];
  }
  populateRunnersSelect();
  updateRunnerBadges();
}

function populateRunnersSelect() {
  const sel = $('sTarget');
  const testSel = $('repoOpsTestRunner');
  
  if (!sel) return;
  
  const val = state.current?.steps?.[state.currentStepIdx]?.target || '';
  
  sel.innerHTML = '';
  if (testSel) testSel.innerHTML = '';
  
  const none = document.createElement('option');
  none.value = '';
  none.textContent = '‚Äî local ‚Äî';
  sel.appendChild(none);
  
  if (testSel) {
    const testNone = document.createElement('option');
    testNone.value = '';
    testNone.textContent = '‚Äî Select runner ‚Äî';
    testSel.appendChild(testNone);
  }
  
  for (const r of state.runners) {
    const status = r.healthy ? '‚úì' : '‚úó';
    const opt = document.createElement('option');
    opt.value = r.name;
    opt.textContent = `${status} ${r.name} (${r.url || 'controller'})`;
    sel.appendChild(opt);
    
    if (testSel) {
      const testOpt = document.createElement('option');
      testOpt.value = r.name;
      testOpt.textContent = `${status} ${r.name} (${r.url || 'controller'})`;
      testSel.appendChild(testOpt);
    }
  }
  
  sel.value = val || '';
}

function updateRunnerBadges() {
  const selectedRunner = $('sTarget')?.value;
  const testRunner = $('repoOpsTestRunner')?.value;
  
  if (selectedRunner) {
    const runner = state.runners.find(r => r.name === selectedRunner);
    const badge = $('stepRunnerBadge');
    if (badge && runner) {
      badge.textContent = runner.healthy ? '‚úì healthy' : '‚úó down';
      badge.className = `badge ${runner.healthy ? 'healthy' : 'unhealthy'}`;
    }
  }
  
  if (testRunner) {
    const runner = state.runners.find(r => r.name === testRunner);
    const badge = $('runnerStatusBadge');
    if (badge && runner) {
      badge.textContent = runner.healthy ? '‚úì healthy' : '‚úó down';
      badge.className = `badge ${runner.healthy ? 'healthy' : 'unhealthy'}`;
    }
  }
}

/* =========================
   Templates
   ========================= */
async function fetchGatewayTemplates() {
  try {
    const r = await fetch('./api/llm-templates', { headers: authHeaders() });
    const data = await r.json();
    state.templates = data.items || [];
  } catch (e) {
    console.warn('Failed to load templates:', e);
    state.templates = [];
  }
  renderTemplates();
}

function renderTemplates() {
  const list = $('templatesList');
  if (!list) return;
  list.innerHTML = '';
  if (!state.templates.length) {
    list.innerHTML = '<p class="muted">No templates available</p>';
    return;
  }
  for (const t of state.templates) {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <div class="horz">
        <div>
          <strong>${escapeHtml(t.name)}</strong>
          <span class="badge">v${t.version}</span>
        </div>
        <div class="grow"></div>
        <button class="ghost use-template-btn" data-template-id="${t.id}">Use in Step</button>
      </div>
      ${t.description ? `<p class="muted">${escapeHtml(t.description)}</p>` : ''}
      <details>
        <summary>Template</summary>
        <pre class="code">${escapeHtml(t.template)}</pre>
      </details>
    `;
    list.appendChild(div);
  }
  list.querySelectorAll('.use-template-btn').forEach(btn => {
    btn.onclick = () => {
      const tid = btn.dataset.templateId;
      const tmpl = state.templates.find(t => t.id == tid);
      if (tmpl && state.current && state.currentStepIdx >= 0) {
        const step = state.current.steps[state.currentStepIdx];
        step.prompt = tmpl.template;
        renderStepEditor();
        toast('Template loaded into current step');
        activateTab('builder');
      }
    };
  });
}

/* =========================
   Telemetry & Cost
   ========================= */
async function fetchGatewayTelemetry() {
  try {
    const r = await fetch('./api/gateway/telemetry?limit=50', { headers: authHeaders() });
    const data = await r.json();
    renderTelemetry(data.items || []);
  } catch (e) {
    console.warn('Failed to load telemetry:', e);
    $('telemetryList').innerHTML = '<p class="muted">Failed to load telemetry</p>';
  }
}

function renderTelemetry(items) {
  const list = $('telemetryList');
  if (!list) return;
  list.innerHTML = '';
  if (!items.length) {
    list.innerHTML = '<p class="muted">No telemetry data</p>';
    return;
  }
  for (const item of items) {
    const div = document.createElement('div');
    div.className = 'card';
    const status = item.state === 'done' ? '‚úì' : item.state === 'error' ? '‚úó' : '‚ãØ';
    const wfId = item.meta?.workflow_id || item.meta?.metadata?.workflow_id || '‚Äî';
    const convId = item.meta?.conversation_id || '‚Äî';
    div.innerHTML = `
      <div class="horz">
        <span class="badge">${status}</span>
        <strong>${escapeHtml(item.model || 'unknown')}</strong>
        <span class="muted">${item.provider || ''}</span>
        <div class="grow"></div>
        <span class="muted small">${item.started_at || ''}</span>
      </div>
      <div class="muted small">Workflow: ${escapeHtml(wfId)} ¬∑ Conversation: ${String(convId).slice(0, 12)}</div>
      ${item.inTok || item.outTok ? `
        <div class="kv">
          <span class="kvp">in: ${item.inTok || 0} tokens</span>
          <span class="kvp">out: ${item.outTok || 0} tokens</span>
          ${item.cost ? `<span class="kvp">${Number(item.cost).toFixed(4)}</span>` : ''}
        </div>
      ` : ''}
    `;
    list.appendChild(div);
  }
}

function populateCostWorkflowSelect() {
  const sel = $('costWorkflowSelect');
  if (!sel) return;
  sel.innerHTML = '';
  for (const wf of state.workflows) {
    const opt = document.createElement('option');
    opt.value = wf.id;
    opt.textContent = wf.name;
    sel.appendChild(opt);
  }
}

async function loadWorkflowCost() {
  const sel = $('costWorkflowSelect');
  if (!sel || !sel.value) return;
  const workflowId = sel.value;
  const report = $('costReport');
  report.innerHTML = '<p class="muted">Loading...</p>';
  try {
    const r = await fetch(`./api/workflows/${encodeURIComponent(workflowId)}/cost?limit=100`, { headers: authHeaders() });
    const data = await r.json();
    if (!data.usage_records) {
      report.innerHTML = '<p class="muted">No cost data found for this workflow</p>';
      return;
    }
    report.innerHTML = `
      <div class="kv">
        <span class="kvp"><strong>Records:</strong> ${data.usage_records}</span>
        <span class="kvp"><strong>Total Cost:</strong> ${Number(data.total_cost).toFixed(4)} ${data.currency}</span>
        <span class="kvp"><strong>Input Tokens:</strong> ${data.total_input_tokens.toLocaleString()}</span>
        <span class="kvp"><strong>Output Tokens:</strong> ${data.total_output_tokens.toLocaleString()}</span>
      </div>
      <details style="margin-top:12px">
        <summary>Usage Records (${data.records.length})</summary>
        <div class="list">
          ${data.records.map(r => `
            <div class="item">
              <div>
                <span class="muted small">${r.ts || ''}</span>
                <span class="badge">${r.input_tokens || 0}‚Üí${r.output_tokens || 0} tokens</span>
                ${r.cost ? `<span class="badge">${Number(r.cost).toFixed(4)}</span>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      </details>
    `;
  } catch (e) {
    report.innerHTML = `<p class="error">Failed to load cost: ${escapeHtml(e.message)}</p>`;
  }
}

/* =========================
   RepoOps UI Integration
   ========================= */
(function() {
  let githubConnections = [];
  const GITHUB_HUB_BASE = '/api/v1/github'; // proxied path

  async function loadGitHubConnections() {
    try {
      const resp = await fetch(`${GITHUB_HUB_BASE}/api/connections`, {
        headers: authHeaders()
      });
      const data = await resp.json();
      githubConnections = data.connections || [];
      populateConnectionsDropdown();
    } catch (e) {
      console.warn('Failed to load GitHub connections:', e);
      githubConnections = [];
      populateConnectionsDropdown();
    }
  }

  function populateConnectionsDropdown() {
    const sel = $('repoOpsConnId');
    if (!sel) return;
    const prev = getCurrentStep()?.repoOps?.conn_id || '';
    sel.innerHTML = '';
    
    if (!githubConnections.length) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = '-- No connections available --';
      sel.appendChild(opt);
      return;
    }
    
    const emptyOpt = document.createElement('option');
    emptyOpt.value = '';
    emptyOpt.textContent = '-- Select connection --';
    sel.appendChild(emptyOpt);
    
    for (const conn of githubConnections) {
      const opt = document.createElement('option');
      opt.value = conn.id;
      opt.textContent = `${conn.name || conn.id} (${conn.repo_url || 'unknown'})`;
      opt.dataset.branches = JSON.stringify(conn.branches || []);
      opt.dataset.defaultBranch = conn.default_branch || 'main';
      sel.appendChild(opt);
    }

    // restore selection if present
    sel.value = prev || '';
  }

  function populateBranchesForConnection() {
    const connSel = $('repoOpsConnId');
    const branchSel = $('repoOpsBaseBranch');
    const step = getCurrentStep();

    if (!connSel || !branchSel) return;
    
    const selectedOpt = connSel.selectedOptions?.[0];
    branchSel.innerHTML = '';

    if (!selectedOpt || !selectedOpt.value) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = '-- Select a connection first --';
      branchSel.appendChild(opt);
      return;
    }
    
    const branches = JSON.parse(selectedOpt.dataset.branches || '[]');
    const defaultBranch = selectedOpt.dataset.defaultBranch || 'main';

    // Build options
    if (!branches.length) {
      const opt = document.createElement('option');
      opt.value = defaultBranch;
      opt.textContent = defaultBranch;
      branchSel.appendChild(opt);
      branchSel.value = defaultBranch;
      return;
    }

    for (const b of branches) {
      const opt = document.createElement('option');
      opt.value = b;
      opt.textContent = b;
      branchSel.appendChild(opt);
    }

    // Restore saved value or default
    const saved = step?.repoOps?.base_branch || '';
    branchSel.value = branches.includes(saved) ? saved : defaultBranch;
  }

  async function refreshBranches(connId) {
    if (!connId) return;
    try {
      const resp = await fetch(`${GITHUB_HUB_BASE}/api/connections/${encodeURIComponent(connId)}/health`, {
        headers: authHeaders()
      });
      const data = await resp.json();
      
      if (data.ok && data.branches) {
        const conn = githubConnections.find(c => c.id === connId);
        if (conn) {
          conn.branches = data.branches;
          // Repaint dropdowns & keep selection
          populateConnectionsDropdown();
          const sel = $('repoOpsConnId');
          if (sel) sel.value = connId;
          populateBranchesForConnection();
        }
      }
    } catch (e) {
      console.warn('Failed to refresh branches:', e);
    }
  }

  async function testConnection() {
    const connId = $('repoOpsConnId')?.value;
    if (!connId) {
      alert('Please select a connection first');
      return;
    }

    const btn = $('testConnBtn');
    const output = $('repoOpsTestOutput');
    
    if (btn) {
      btn.disabled = true;
      btn.textContent = '‚è≥';
    }
    
    output.innerHTML = '<p class="muted">Testing connection...</p>';

    try {
      const resp = await fetch(
        `${GITHUB_HUB_BASE}/api/connections/${encodeURIComponent(connId)}/health`,
        { headers: authHeaders() }
      );
      const data = await resp.json();

      if (!resp.ok || !data.ok) {
        output.innerHTML = `
          <div class="error">
            ‚ùå Connection failed: ${data.error || 'Unknown error'}
          </div>
        `;
        return;
      }

      output.innerHTML = `
        <div class="card">
          <h4>‚úÖ Connection successful</h4>
          <p><strong>Branches found:</strong> ${data.branches?.length || 0}</p>
          <details>
            <summary>Available branches</summary>
            <ul>
              ${(data.branches || []).map(b => `<li>${escapeHtml(b)}</li>`).join('')}
            </ul>
          </details>
        </div>
      `;

      await loadGitHubConnections();
      populateBranchesForConnection();
    } catch (e) {
      output.innerHTML = `
        <div class="error">
          ‚ùå Test failed: ${escapeHtml(e.message)}
        </div>
      `;
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'üîó';
      }
    }
  }

  // Wire RepoOps UI events
  $('repoOpsConnId')?.addEventListener('change', async (e) => {
    populateBranchesForConnection();
    if (e.target.value) {
      await refreshBranches(e.target.value);
    }
    // persist immediately in step state
    collectWorkflowFromForm();
  });

  $('repoOpsBaseBranch')?.addEventListener('change', () => {
    collectWorkflowFromForm();
  });

  $('refreshConnBtn')?.addEventListener('click', async () => {
    const btn = $('refreshConnBtn');
    const connId = $('repoOpsConnId')?.value;
    
    btn.disabled = true;
    btn.textContent = '‚è≥';
    
    try {
      await loadGitHubConnections();
      if (connId) {
        await refreshBranches(connId);
      }
    } finally {
      btn.disabled = false;
      btn.textContent = '‚Üª';
    }
  });

  $('testConnBtn')?.addEventListener('click', testConnection);

  $('repoOpsTestEnabled')?.addEventListener('change', (e) => {
    const settings = $('repoOpsTestSettings');
    if (settings) settings.style.display = e.target.checked ? '' : 'none';
    collectWorkflowFromForm();
  });

  $('repoOpsTestRunner')?.addEventListener('change', () => {
    updateRunnerBadges();
    collectWorkflowFromForm();
  });

  function splitLines(val) {
    return (val || '').split('\n').map(s => s.trim()).filter(Boolean);
  }
  function splitComma(val) {
    return (val || '').split(',').map(s => s.trim()).filter(Boolean);
  }

// replace BOTH existing listeners for repoOpsPlanBtn and repoOpsTestStepBtn with this:

function showRepoOpsLoading(btn, msg = 'Working‚Ä¶') {
  const out = $('repoOpsTestOutput');
  if (btn) { btn.disabled = true; btn.dataset._label = btn.textContent; btn.textContent = '‚è≥'; }
  if (out) out.innerHTML = `<p class="muted">${escapeHtml(msg)}</p>`;
}
function resetRepoOpsLoading(btn) {
  if (btn) { btn.disabled = false; btn.textContent = btn.dataset._label || btn.textContent; }
}
function renderRepoOpsError(err) {
  const out = $('repoOpsTestOutput');
  if (!out) return;
  out.innerHTML = `<div class="error">‚ùå ${escapeHtml(err || 'Unknown error')}</div>`;
}
function getActiveVars() {
  return parseJson($('varsInput')?.value || '{}', {});
}
function ensureRepoOpsReady(cfg) {
  if (!cfg.conn_id) throw new Error('Select a GitHub connection first.');
  if (!cfg.base_branch) throw new Error('Select a base branch.');
  return cfg;
}

$('repoOpsPlanBtn')?.addEventListener('click', async (e) => {
  const btn = e.currentTarget;
  try {
    // Always collect fresh config from the form
    const cfg = ensureRepoOpsReady(window.RepoOpsUI?.collectConfig?.());
    const vars = getActiveVars();
    const body = {
      conn_id: cfg.conn_id,
      base_branch: cfg.base_branch,
      change_request: renderTemplate(cfg.change_request, vars),
      allow_paths: cfg.allow_paths?.length ? cfg.allow_paths : undefined,
      deny_paths: cfg.deny_paths?.length ? cfg.deny_paths : undefined,
      language_hints: cfg.language_hints?.length ? cfg.language_hints : undefined,
      llm_model: cfg.llm_model,
      temperature: cfg.temperature
    };

    showRepoOpsLoading(btn, 'Planning‚Ä¶');
    const resp = await fetch(`${REPOOPS_BASE}/plan`, {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(body)
    });

    const text = await resp.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { error: text || 'Non-JSON response' }; }

    if (!resp.ok) throw new Error(data.error || resp.statusText);

    $('repoOpsTestOutput').innerHTML = `
      <div class="card">
        <h4>‚úÖ Plan Generated</h4>
        <p><strong>Files selected:</strong> ${data.discovery?.files?.length || 0}</p>
        <p><strong>Changes proposed:</strong> ${data.proposed?.changes?.length || 0}</p>
        <details>
          <summary>Discovery</summary>
          <pre class="code">${escapeHtml(JSON.stringify(data.discovery, null, 2))}</pre>
        </details>
        <details>
          <summary>Proposed Changes</summary>
          <pre class="code">${escapeHtml(JSON.stringify(data.proposed, null, 2))}</pre>
        </details>
      </div>
    `;
  } catch (err) {
    renderRepoOpsError(err.message || String(err));
  } finally {
    resetRepoOpsLoading(btn);
  }
});

$('repoOpsTestStepBtn')?.addEventListener('click', async (e) => {
  const btn = e.currentTarget;
  try {
    const cfg = ensureRepoOpsReady(window.RepoOpsUI?.collectConfig?.());
    const vars = getActiveVars();

    // default a head branch if the user didn‚Äôt set one
    const headBranch = cfg.head_branch || `test/${Date.now()}`;

    const body = {
      conn_id: cfg.conn_id,
      base_branch: cfg.base_branch,
      head_branch: headBranch,
      change_request: renderTemplate(cfg.change_request, vars),
      allow_paths: cfg.allow_paths?.length ? cfg.allow_paths : undefined,
      deny_paths: cfg.deny_paths?.length ? cfg.deny_paths : undefined,
      language_hints: cfg.language_hints?.length ? cfg.language_hints : undefined,
      llm_model: cfg.llm_model,
      temperature: cfg.temperature,
      test: cfg.test,
      open_pr: cfg.open_pr,
      pr_draft: cfg.pr_draft,
      require_approval: false // keep interactive approval out of the test path
    };

    showRepoOpsLoading(btn, 'Running full RepoOps flow‚Ä¶');
    const resp = await fetch(`${REPOOPS_BASE}/run`, {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(body)
    });

    const text = await resp.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { error: text || 'Non-JSON response' }; }

    if (!resp.ok) throw new Error(data.error || resp.statusText);

    const phases = data.phases || {};
    $('repoOpsTestOutput').innerHTML = `
      <div class="card">
        <h4>${data.status === 'completed' ? '‚úÖ' : '‚ö†Ô∏è'} ${escapeHtml(data.status || '')}</h4>
        ${phases.plan ? `<p><strong>Plan:</strong> ${phases.plan.proposed?.changes?.length || 0} changes</p>` : ''}
        ${phases.apply ? `<p><strong>Applied:</strong> ${phases.apply.applied} files (commit: ${escapeHtml(phases.apply.commit_sha || '').slice(0,8)})</p>` : ''}
        ${phases.test ? `<p><strong>Tests:</strong> ${phases.test.ok ? '‚úÖ Passed' : '‚ùå Failed'}</p>` : ''}
        ${phases.pr ? `<p><strong>PR:</strong> <a href="${escapeHtml(phases.pr.url)}" target="_blank">#${phases.pr.number}</a></p>` : ''}
        <details>
          <summary>Full Results</summary>
          <pre class="code">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
        </details>
      </div>
    `;
  } catch (err) {
    renderRepoOpsError(err.message || String(err));
  } finally {
    resetRepoOpsLoading(btn);
  }
});


  function collectRepoOpsConfig() {
    return {
      kind: 'repoops',
      conn_id: $('repoOpsConnId')?.value || '',
      base_branch: $('repoOpsBaseBranch')?.value || 'main',
      head_branch: $('repoOpsHeadBranch')?.value || '',
      change_request: $('repoOpsChangeRequest')?.value || '',
      allow_paths: splitLines($('repoOpsAllowPaths')?.value),
      deny_paths: splitLines($('repoOpsDenyPaths')?.value),
      language_hints: splitComma($('repoOpsLanguageHints')?.value),
      llm_model: $('repoOpsModel')?.value || 'gpt-4o-mini',
      temperature: parseFloat($('repoOpsTemperature')?.value || '0.2'),
      test: {
        enabled: $('repoOpsTestEnabled')?.checked || false,
        runner: $('repoOpsTestRunner')?.value || '',
        commands: splitLines($('repoOpsTestCommands')?.value),
        timeoutMs: parseInt($('repoOpsTestTimeout')?.value || '900000')
      },
      open_pr: $('repoOpsOpenPR')?.checked || false,
      pr_draft: $('repoOpsPRDraft')?.checked || false,
      require_approval: $('repoOpsRequireApproval')?.checked || false,
      export_pr_url_as: $('repoOpsExportPRAs')?.value || '',
      export_head_branch_as: $('repoOpsExportBranchAs')?.value || ''
    };
  }

  // Expose helpers
  window.RepoOpsUI = {
    loadConnections: loadGitHubConnections,
    refreshBranches,
    testConnection,
    collectConfig: collectRepoOpsConfig,
    populateBranchesForConnection,
    getConnections: () => githubConnections
  };

  // Initial load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadGitHubConnections);
  } else {
    loadGitHubConnections();
  }
})();

/* =========================
   Workflows
   ========================= */
function newWorkflow() {
  return {
    id: null,
    name: 'New Workflow',
    description: '',
    defaults: {},
    chat: { provider: 'openai', baseUrl: '', apiKey: '', model: '', temperature: 0.2 },
    steps: [],
    createdAt: null,
    updatedAt: null
  };
}

function defaultActionSchema() {
  return {
    $schema: 'http://json-schema.org/draft-07/schema#',
    type: 'object',
    required: ['actions'],
    properties: {
      actions: {
        type: 'array',
        items: {
          type: 'object',
          required: ['type', 'content'],
          properties: {
            type: { type: 'string', enum: ['bash', 'python', 'sql', 'http', 'plan', 'text'] },
            content: { type: 'string' },
            filename: { type: 'string' },
            cwd: { type: 'string' },
            env: { type: 'object' },
            meta: { type: 'object' }
          }
        }
      },
      notes: { type: 'string' }
    }
  };
}

function newStep() {
  const currentModel = state.current?.chat?.model || '';
  return {
    id: `step_${Date.now().toString(36)}`,
    type: 'llm',
    name: 'Step',
    prompt: 'Given the task: {{task}}\nReturn actions to perform.\n',
    schema: defaultActionSchema(),
    systemGuard: true,
    stopOnFailure: true,
    exportPath: '',
    exportAs: '',
    provider: '',
    baseUrl: '',
    apiKey: '',
    model: currentModel,
    temperature: '',
    target: '',
    // persist RepoOps block entirely here
    repoOps: {
      kind: 'repoops',
      conn_id: '',
      base_branch: 'main',
      head_branch: '',
      change_request: '',
      allow_paths: [],
      deny_paths: [],
      language_hints: [],
      llm_model: currentModel || 'gpt-4o-mini',
      temperature: 0.2,
      test: { enabled: false, runner: '', commands: [], timeoutMs: 900000 },
      open_pr: false,
      pr_draft: false,
      require_approval: false,
      export_pr_url_as: '',
      export_head_branch_as: ''
    }
  };
}

async function loadWorkflows() {
  try {
    let resp = await fetch('./api/workflows', { headers: authHeaders() });
    if (resp.status === 401) {
      promptSetToken();
      updateTokenUi();
      resp = await fetch('./api/workflows', { headers: authHeaders() });
    }
    const data = await resp.json();
    state.workflows = data.workflows || [];
  } catch (e) {
    console.warn('Failed to load workflows:', e);
    state.workflows = [];
  }
  renderWorkflowList();
  populateCostWorkflowSelect();
}

async function saveCurrent() {
  const wf = collectWorkflowFromForm();
  try {
    const resp = await fetch('./api/workflows', {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(wf)
    });
    const data = await resp.json();
    if (!resp.ok || !data.ok) {
      toast('Save failed: ' + (data.error || resp.statusText || 'Unknown'));
      return;
    }
    state.current = data.workflow;
    const idx = state.workflows.findIndex(w => w.id === state.current.id);
    if (idx >= 0) state.workflows[idx] = state.current;
    else state.workflows.push(state.current);
    renderWorkflowList();
    renderWorkflowEditor();
    populateCostWorkflowSelect();
    toast('Saved');
  } catch (e) {
    toast('Save failed: ' + e.message);
  }
}

async function deleteCurrent() {
  if (!state.current?.id) {
    toast('Nothing selected');
    return;
  }
  if (!confirm('Delete this workflow?')) return;
  try {
    const resp = await fetch(`./api/workflows/${state.current.id}`, {
      method: 'DELETE',
      headers: authHeaders()
    });
    if (resp.ok) {
      state.workflows = state.workflows.filter(w => w.id !== state.current.id);
      state.current = null;
      state.currentStepIdx = -1;
      renderWorkflowList();
      renderWorkflowEditor();
      populateCostWorkflowSelect();
    } else {
      toast('Delete failed');
    }
  } catch (e) {
    toast('Delete failed: ' + e.message);
  }
}

async function runCurrent() {
  const wf = collectWorkflowFromForm();
  if (!wf.id) {
    toast('Please save the workflow before running.');
    return;
  }
  const vars = parseJson($('varsInput').value || '{}', {});
  try {
    const resp = await fetch(`./api/workflows/${wf.id}/run`, {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ vars })
    });
    const data = await resp.json();
    if (!resp.ok) {
      toast('Run failed: ' + (data.error || resp.statusText));
      return;
    }
    renderRunResult(data);
    await loadRuns();
  } catch (e) {
    toast('Run failed: ' + e.message);
  }
}

async function testStep() {
  const wf = collectWorkflowFromForm();
  const step = wf.steps[state.currentStepIdx];
  if (!step) {
    toast('Select a step');
    return;
  }
  if (step.type === 'repoops') {
    toast('Use "Plan Only" or "Full Test" in the RepoOps section to test this step.');
    return;
  }
  const vars = parseJson($('varsInput').value || '{}', {});
  try {
    const resp = await fetch('./api/testStep', {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({
        chat: wf.chat,
        step,
        vars,
        execute: $('execInTest')?.checked === true
      })
    });
    const data = await resp.json();
    if (!resp.ok) {
      toast('Step test failed: ' + (data.error || resp.statusText));
      renderStepTestResult({ ok: false, error: data.error || 'HTTP error', raw: data.errorText || '' });
      return;
    }
    renderStepTestResult(data);
  } catch (e) {
    toast('Step test failed: ' + e.message);
  }
}

async function dryRunStep() {
  const wf = collectWorkflowFromForm();
  const step = wf.steps[state.currentStepIdx];
  if (!step) {
    toast('Select a step');
    return;
  }
  if (step.type === 'repoops') {
    toast('Dry run is only for LLM steps.');
    return;
  }
  try {
    const resp = await fetch('./api/testStep', {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({
        chat: wf.chat,
        step,
        vars: {},
        dryRun: true
      })
    });
    const data = await resp.json();
    $('testOutput').innerHTML = `
      <div class="card">
        <div class="horz">
          <span class="badge success">Dry Run</span>
          <strong>Validation: ${data.validated ? '‚úì Passed' : '‚úó Failed'}</strong>
        </div>
        <pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>
      </div>
    `;
  } catch (e) {
    toast('Dry run failed: ' + e.message);
  }
}

function getCurrentStep() {
  return state.current?.steps?.[state.currentStepIdx] || null;
}

function collectWorkflowFromForm() {
  if (!state.current) state.current = newWorkflow();

  state.current.name = $('wfName').value.trim();
  state.current.description = $('wfDesc').value;
  state.current.chat = {
    provider: $('provider').value,
    baseUrl: $('baseUrl').value.trim(),
    apiKey: $('apiKey').value.trim(),
    model: $('model').value.trim(),
    temperature: $('temperature').value !== '' ? Number($('temperature').value) : undefined,
    max_tokens: $('max_tokens').value !== '' ? Number($('max_tokens').value) : undefined
  };
  state.current.defaults = parseJson($('defaults').value || '{}', {});

  if (state.currentStepIdx >= 0 && state.current.steps[state.currentStepIdx]) {
    const s = state.current.steps[state.currentStepIdx];
    s.name = $('stepName').value.trim();
    s.type = $('stepType').value || 'llm';
    s.exportPath = $('stepExportPath').value.trim();
    s.exportAs = $('stepExportAs').value.trim();
    s.provider = $('sProvider').value.trim();
    s.baseUrl = $('sBaseUrl').value.trim();
    s.apiKey = $('sApiKey').value.trim();
    s.model = $('sModel').value.trim();
    s.target = $('sTarget')?.value || '';
    s.temperature = $('sTemp').value !== '' ? Number($('sTemp').value) : '';

    if (s.type === 'llm') {
      s.prompt = $('stepPrompt').value;
      s.systemGuard = !$('stepNoGuard').checked;
      s.schema = parseJson($('stepSchema').value || '', s.schema);
      s.stopOnFailure = !$('stepDontStop').checked;
      s.repoOps = s.repoOps || null;
    } else if (s.type === 'repoops') {
      // Pull full config from UI
      const conf = window.RepoOpsUI?.collectConfig?.() || s.repoOps || {};
      // persist
      s.repoOps = conf;
    }
  }
  return state.current;
}

function renderWorkflowList() {
  const list = $('wfList');
  list.innerHTML = '';
  state.workflows.forEach(w => {
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div>
        <strong>${escapeHtml(w.name)}</strong>
        <span class="pill">${w.chat?.model || '(model)'}</span>
      </div>
      <button class="ghost">Open</button>
    `;
    const btn = div.querySelector('button');
    btn.onclick = async () => {
      try {
        const resp = await fetch(`./api/workflows/${w.id}`, { headers: authHeaders() });
        const data = await resp.json();
        state.current = data.workflow;
        state.currentStepIdx = -1;
        renderWorkflowEditor();
        activateTab('builder');
      } catch (e) {
        toast('Load failed: ' + e.message);
      }
    };
    list.appendChild(div);
  });
}

function renderWorkflowEditor() {
  if (!state.current) {
    $('wfName').value = '';
    $('wfDesc').value = '';
    $('provider').value = 'openai';
    $('baseUrl').value = '';
    $('apiKey').value = '';
    $('model').value = '';
    $('temperature').value = '';
    $('max_tokens').value = '';
    $('defaults').value = '{}';
    populateModelSelects();
    renderSteps();
    renderStepEditor();
    return;
  }
  $('wfName').value = state.current.name || '';
  $('wfDesc').value = state.current.description || '';
  $('provider').value = state.current.chat?.provider || 'openai';
  $('baseUrl').value = state.current.chat?.baseUrl || '';
  $('apiKey').value = state.current.chat?.apiKey || '';
  $('model').value = state.current.chat?.model || '';
  $('temperature').value = state.current.chat?.temperature ?? '';
  $('max_tokens').value = state.current.chat?.max_tokens ?? '';
  $('defaults').value = fmtJson(state.current.defaults || {});
  populateModelSelects();
  renderSteps();
  renderStepEditor();
}

function renderSteps() {
  const list = $('stepsList');
  list.innerHTML = '';
  const steps = state.current?.steps || [];
  steps.forEach((s, idx) => {
    const row = document.createElement('div');
    row.className = 'wf-step';
    row.innerHTML = `
      <div class="horz">
        <strong>${escapeHtml(s.name || s.id)}</strong>
        <span class="pill">${s.type === 'repoops' ? 'RepoOps' : (s.model || '(inherit)')}</span>
        <div class="grow"></div>
        <button class="ghost">‚Üë</button>
        <button class="ghost">‚Üì</button>
        <button class="ghost">Edit</button>
        <button class="danger">‚úï</button>
      </div>
    `;
    const [bUp, bDown, bEdit, bRm] = row.querySelectorAll('button');
    bUp.onclick = () => moveStep(idx, -1);
    bDown.onclick = () => moveStep(idx, +1);
    bEdit.onclick = () => { state.currentStepIdx = idx; renderStepEditor(); };
    bRm.onclick = () => removeStep(idx);
    list.appendChild(row);
  });
}

function toggleStepTypeUi(type) {
  const llmOnly = document.querySelector('.llm-only');
  const repo = $('repoOpsEditor');
  if (llmOnly) llmOnly.style.display = type === 'llm' ? '' : 'none';
  if (repo) repo.style.display = type === 'repoops' ? '' : 'none';
}

/* ============
   CRITICAL: renderStepEditor restores RepoOps state & branches
   ============ */
async function renderStepEditor() {
  const steps = state.current?.steps || [];
  const s = steps[state.currentStepIdx];
  const noStep = !s;
  $('stepEditor').style.display = noStep ? 'none' : '';
  $('noStepHint').style.display = noStep ? '' : 'none';
  if (noStep) return;

  // Common fields
  $('stepName').value = s.name || '';
  $('stepType').value = s.type || 'llm';
  toggleStepTypeUi(s.type || 'llm');

  // LLM
  $('stepPrompt').value = s.prompt || '';
  $('stepSchema').value = typeof s.schema === 'string' ? s.schema : fmtJson(s.schema || {});
  $('stepNoGuard').checked = !s.systemGuard;
  $('stepDontStop').checked = !s.stopOnFailure;

  // Exports & overrides
  $('stepExportPath').value = s.exportPath || '';
  $('stepExportAs').value = s.exportAs || '';
  $('sProvider').value = s.provider || '';
  $('sBaseUrl').value = s.baseUrl || '';
  $('sApiKey').value = s.apiKey || '';
  $('sModel').value = s.model || '';
  $('sTemp').value = s.temperature ?? '';

  populateRunnersSelect();
  populateModelSelect($('sModelSelect'), $('sModelInfo'), s.model || '');
  updateRunnerBadges();

  // ---- RepoOps restore & UI wiring ----
  if (s.type === 'repoops') {
    // Ensure repoOps object exists
    if (!s.repoOps) s.repoOps = { kind: 'repoops', conn_id: '', base_branch: 'main' };

    // 1) Ensure connections loaded (async), then select saved connection
    await window.RepoOpsUI?.loadConnections?.();
    const connSel = $('repoOpsConnId');
    if (connSel) {
      connSel.value = s.repoOps.conn_id || '';
    }

    // 2) Populate branches for that connection, then set saved base branch
    window.RepoOpsUI?.populateBranchesForConnection?.();
    const branchSel = $('repoOpsBaseBranch');
    if (branchSel) {
      // If saved branch isn't in the list (first render), set after a microtask,
      // but try synchronously first:
      const want = s.repoOps.base_branch || 'main';
      if (Array.from(branchSel.options).some(o => o.value === want)) {
        branchSel.value = want;
      } else {
        queueMicrotask(() => { branchSel.value = want; });
      }
    }

    // 3) Restore rest of RepoOps fields
    $('repoOpsHeadBranch').value = s.repoOps.head_branch || '';
    $('repoOpsLanguageHints').value = (s.repoOps.language_hints || []).join(',');
    $('repoOpsChangeRequest').value = s.repoOps.change_request || '';
    $('repoOpsAllowPaths').value = (s.repoOps.allow_paths || []).join('\n');
    $('repoOpsDenyPaths').value = (s.repoOps.deny_paths || []).join('\n');
    $('repoOpsModel').value = s.repoOps.llm_model || (state.current?.chat?.model || 'gpt-4o-mini');
    $('repoOpsTemperature').value = s.repoOps.temperature ?? 0.2;

    $('repoOpsTestEnabled').checked = !!s.repoOps?.test?.enabled;
    const testSettings = $('repoOpsTestSettings');
    if (testSettings) testSettings.style.display = s.repoOps?.test?.enabled ? '' : 'none';
    $('repoOpsTestRunner').value = s.repoOps?.test?.runner || '';
    $('repoOpsTestCommands').value = (s.repoOps?.test?.commands || []).join('\n');
    $('repoOpsTestTimeout').value = s.repoOps?.test?.timeoutMs ?? 900000;

    $('repoOpsOpenPR').checked = !!s.repoOps.open_pr;
    $('repoOpsPRDraft').checked = !!s.repoOps.pr_draft;
    $('repoOpsRequireApproval').checked = !!s.repoOps.require_approval;
    $('repoOpsExportPRAs').value = s.repoOps.export_pr_url_as || '';
    $('repoOpsExportBranchAs').value = s.repoOps.export_head_branch_as || '';
  }
}

function removeStep(idx) {
  state.current.steps.splice(idx, 1);
  if (state.currentStepIdx === idx) state.currentStepIdx = -1;
  renderSteps();
  renderStepEditor();
}

function moveStep(idx, delta) {
  const steps = state.current.steps;
  const j = idx + delta;
  if (j < 0 || j >= steps.length) return;
  const [m] = steps.splice(idx, 1);
  steps.splice(j, 0, m);
  if (state.currentStepIdx === idx) state.currentStepIdx = j;
  renderSteps();
}

function addStep() {
  if (!state.current) state.current = newWorkflow();
  collectWorkflowFromForm();
  state.current.steps.push(newStep());
  state.currentStepIdx = state.current.steps.length - 1;
  renderSteps();
  renderStepEditor();
}

async function loadRuns() {
  try {
    const resp = await fetch('./api/runs', { headers: authHeaders() });
    const data = await resp.json();
    state.runs = data.runs || [];
  } catch (e) {
    console.warn('Runs load failed:', e);
    state.runs = [];
  }
  renderRuns();
}

function renderRuns() {
  const list = $('runsList');
  list.innerHTML = '';
  state.runs.slice().reverse().forEach(r => {
    const item = document.createElement('div');
    item.className = 'item';
    const badge = r.status === 'ok' ? 'success' : r.status === 'failed' ? 'error' : 'warn';
    item.innerHTML = `
      <div>
        <strong>${escapeHtml(r.name)}</strong>
        <span class="badge ${badge}">${r.status}</span>
        <div class="muted small">${r.id?.slice(0, 8) || ''} ¬∑ ${r.startedAt || ''}</div>
      </div>
      <button class="ghost">Details</button>
    `;
    item.querySelector('button').onclick = () => renderRunResult(r);
    list.appendChild(item);
  });
}

function renderRunResult(run) {
  activateTab('runs');
  $('runDetail').innerHTML = `
    <div class="card">
      <div class="horz">
        <div>
          <strong>${escapeHtml(run.name || '')}</strong>
          <span class="badge">${run.status || ''}</span>
        </div>
        <div class="grow"></div>
        ${run.conversationId ? `<button class="ghost" onclick="exportConversation('${run.id}')">üì§ Export Conversation</button>` : ''}
      </div>
      <div class="muted">Started: ${run.startedAt || ''} ¬∑ Finished: ${run.finishedAt || ''}</div>
      ${run.conversationId ? `<div class="muted small">Conversation ID: ${run.conversationId}</div>` : ''}
      <h4>Artifacts (${run.artifacts?.length || 0})</h4>
      ${renderArtifacts(run.artifacts || [])}
      <h4>Logs</h4>
      <pre class="wf-log">${(run.logs || []).map(l => `[${l.ts}] [${l.step || '-'}] ${String(l.level || '').toUpperCase()} ${l.msg}${l.meta ? ' ' + JSON.stringify(l.meta) : ''}`).join('\n')}</pre>
    </div>
  `;
}

function renderArtifacts(artifacts) {
  if (!artifacts.length) return '<div class="muted">No artifacts</div>';
  return artifacts.map(a => `
    <div class="artifact">
      <div>
        <span class="badge">${a.type}</span>
        <span class="muted">from: ${escapeHtml(a.step || '')}</span>
      </div>
      ${a.filename ? `<div class="muted">file: ${escapeHtml(a.filename)}</div>` : ''}
      <pre class="code">${escapeHtml(a.content || '')}</pre>
    </div>
  `).join('');
}

function renderStepTestResult(data) {
  $('testOutput').innerHTML = `
    <div class="card">
      <div><strong>OK:</strong> ${String(!!data.ok)}</div>
      <h4>Validation</h4>
      <pre>${escapeHtml(JSON.stringify(data.validation || {}, null, 2))}</pre>
      <h4>JSON</h4>
      <pre>${escapeHtml(JSON.stringify(data.json || {}, null, 2))}</pre>
      <h4>Raw</h4>
      <pre class="wf-log">${escapeHtml(((data.raw || data.error || '') + '').slice(0, 4000))}</pre>
      ${data.actionResults?.length ? `
        <h4>Action Results</h4>
        ${data.actionResults.map(r => `
          <div class="artifact">
            <div><span class="badge">${escapeHtml(r.kind || '')}</span> index: ${r.index}</div>
            ${r.error ? `<div class="error">error: ${escapeHtml(r.error)}</div>` : `
              <div class="muted">exit: ${r.exitCode} ${r.killed ? '(killed)' : ''}</div>
              <pre class="wf-log">${escapeHtml((r.stdout || '').slice(0, 2000))}</pre>
            `}
          </div>
        `).join('')}
      ` : ''}
    </div>
  `;
}

async function exportConversation(runId) {
  try {
    const r = await fetch(`./api/runs/${runId}/conversation`, { headers: authHeaders() });
    const data = await r.json();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `conversation_${runId}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  } catch (e) {
    toast('Export failed: ' + e.message);
  }
}

function activateTab(name) {
  const tabs = ['builder', 'runs', 'telemetry', 'templates'];
  tabs.forEach(t => {
    $(`tab-${t}`).style.display = (t === name) ? '' : 'none';
    $(`tabBtn${capitalize(t)}`).classList.toggle('active', t === name);
  });
  if (name === 'telemetry') fetchGatewayTelemetry();
  if (name === 'templates') fetchGatewayTemplates();
}

function capitalize(s) {
  return s.charAt(0).toUpperCase() + s.slice(1);
}

/* =========================
   Event handlers
   ========================= */
document.addEventListener('DOMContentLoaded', async () => {
  $('tabBtnBuilder').addEventListener('click', () => activateTab('builder'));
  $('tabBtnRuns').addEventListener('click', () => activateTab('runs'));
  $('tabBtnTelemetry').addEventListener('click', () => activateTab('telemetry'));
  $('tabBtnTemplates').addEventListener('click', () => activateTab('templates'));
  
  $('setTokenBtn').addEventListener('click', promptSetToken);
  $('newWfBtn').addEventListener('click', () => {
    state.current = newWorkflow();
    state.currentStepIdx = -1;
    renderWorkflowEditor();
  });
  $('saveWfBtn').addEventListener('click', saveCurrent);
  $('deleteWfBtn').addEventListener('click', deleteCurrent);
  $('addStepBtn').addEventListener('click', addStep);
  $('testStepBtn').addEventListener('click', testStep);
  $('dryRunBtn').addEventListener('click', dryRunStep);
  $('runWfBtn').addEventListener('click', runCurrent);
  
  $('modelSelect')?.addEventListener('change', () => onModelSelectChanged(false));
  $('sModelSelect')?.addEventListener('change', () => onModelSelectChanged(true));
  $('refreshModelsBtn')?.addEventListener('click', fetchGatewayModels);
  $('refreshModelsBtn2')?.addEventListener('click', fetchGatewayModels);
  $('refreshRunnersBtn')?.addEventListener('click', fetchRunners);
  $('sTarget')?.addEventListener('change', updateRunnerBadges);

  $('refreshTelemetryBtn')?.addEventListener('click', fetchGatewayTelemetry);
  $('refreshTemplatesBtn')?.addEventListener('click', fetchGatewayTemplates);
  $('loadCostBtn')?.addEventListener('click', loadWorkflowCost);

  $('stepType')?.addEventListener('change', (e) => {
    toggleStepTypeUi(e.target.value);
    collectWorkflowFromForm();
    // Repaint RepoOps bits when switching into it
    if (e.target.value === 'repoops') {
      renderStepEditor();
    }
  });
  
  const autoIds = [
    'wfName','wfDesc','provider','baseUrl','apiKey','model','temperature','max_tokens','defaults',
    'stepName','stepPrompt','stepSchema','stepNoGuard','stepDontStop','stepExportPath','stepExportAs',
    'sProvider','sBaseUrl','sApiKey','sModel','sTemp','sTarget',
    // RepoOps live fields that shouldn't wait for explicit clicks
    'repoOpsHeadBranch','repoOpsLanguageHints','repoOpsChangeRequest',
    'repoOpsAllowPaths','repoOpsDenyPaths','repoOpsModel','repoOpsTemperature',
    'repoOpsTestCommands','repoOpsTestTimeout','repoOpsOpenPR','repoOpsPRDraft',
    'repoOpsRequireApproval','repoOpsExportPRAs','repoOpsExportBranchAs'
  ];
  autoIds.forEach(id => {
    const el = $(id);
    if (el) {
      el.addEventListener('change', collectWorkflowFromForm);
      if (el.tagName === 'TEXTAREA') el.addEventListener('input', collectWorkflowFromForm);
      if (el.tagName === 'INPUT' && (el.type === 'text' || el.type === 'number')) {
        el.addEventListener('input', collectWorkflowFromForm);
      }
    }
  });

  updateTokenUi();
  activateTab('builder');

  await fetchGatewayModels();
  await fetchRunners();
  await loadWorkflows();
  await loadRuns();
});
  </script>
</body>
</html>
