<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LLM Gateway Admin</title>
  <base href="/api/v1/gateway/">
  <link rel="stylesheet" href="./css/theme.css" />
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .muted { color: var(--muted); }
    .kpis { display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 12px; }
    .kpi { background:#1e1e1e; border:1px solid var(--line); border-radius:8px; padding:8px 10px; }
    .kpi .v { font-size:18px; }
    .table-wrap { overflow:auto; }
    table { width:100%; border-collapse: collapse; }
    th, td { border: 1px solid var(--line); padding: 6px 8px; font-size: 12px; }
    th { text-align:left; background:#1f1f1f; }
    .badge { padding:2px 6px; border-radius:6px; font-size:11px; background:#333; }
    .badge.live { background:#3b7; color:#fff; }
    .badge.done { background:#274; color:#cfe; }
    .badge.error { background:#a33; color:#fee; }
  </style>
</head>
<body>
  <div class="header">
    <div class="inline">
      <span class="dot" id="dot"></span>
      <strong>LLM Gateway</strong>
    </div>
    <div class="grow"></div>
    <button id="healthBtn" class="ghost">Health Check</button>
    <span id="healthText" class="muted">Idle</span>
  </div>

  <!-- Top-level tabs -->
  <div class="main-tabs">
    <button class="tab active" data-tab="admin">Admin</button>
    <button class="tab" data-tab="live">Live</button>
  </div>

  <!-- ADMIN PANE -->
  <div id="adminPane" class="pane">
    <h2 style="margin:10px 0 12px">‚öôÔ∏è LLM Gateway ‚Äì Admin</h2>

    <!-- Providers -->
    <div class="card">
      <h3>Providers</h3>
      <div class="row">
        <div>
          <label>Name</label><input id="pName" placeholder="openai / together / ollama-local">
          <label>Kind</label>
          <select id="pKind">
            <option value="openai">openai</option>
            <option value="openai-compatible">openai-compatible</option>
            <option value="ollama">ollama</option>
          </select>
        </div>
        <div>
          <label>Base URL</label><input id="pBaseUrl" placeholder="https://api.openai.com">
          <label>API Key</label><input id="pApiKey" placeholder="sk-... (optional)">
        </div>
      </div>
      <label>Headers (JSON)</label>
      <textarea id="pHeaders" rows="3" placeholder='{"X-Client":"gw"}'></textarea>
      <div class="inline">
        <button id="saveProvider" class="btn">Save Provider</button>
        <button id="resetProvider" class="ghost">Reset</button>
      </div>
      <div class="table-wrap">
        <table id="providersTbl" style="margin-top:8px;">
          <thead>
            <tr>
              <th>ID</th><th>Name</th><th>Kind</th><th>Base URL</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Models -->
    <div class="card">
      <h3>Models</h3>
      <div class="row">
        <div>
          <label>Provider ID</label><input id="mProviderId" placeholder="e.g. 1">
          <label>Model name (upstream)</label><input id="mModelName" placeholder="gpt-4o-mini or gpt-5 or llama3">
        </div>
        <div>
          <label>Key (optional unique)</label><input id="mKey" placeholder="openai:gpt-4o-mini">
          <label>Display name</label><input id="mDisplayName" placeholder="GPT-4o Mini">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Mode</label>
          <select id="mMode">
            <option value="auto">auto</option>
            <option value="chat">chat</option>
            <option value="responses">responses</option>
          </select>
          <label>Supports responses</label>
          <select id="mResp">
            <option value="false">false</option>
            <option value="true">true</option>
          </select>
        </div>
        <div>
          <label>Supports reasoning</label>
          <select id="mReason">
            <option value="false">false</option>
            <option value="true">true</option>
          </select>
          <label>Currency</label><input id="mCurrency" value="USD">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Input cost per 1M tokens</label><input id="mInCost" type="number" step="0.000001" value="0">
        </div>
        <div>
          <label>Output cost per 1M tokens</label><input id="mOutCost" type="number" step="0.000001" value="0">
        </div>
      </div>
      <div class="inline">
        <button id="saveModel" class="btn">Save Model</button>
        <button id="resetModel" class="ghost">Reset</button>
      </div>
      <div class="table-wrap">
        <table id="modelsTbl" style="margin-top:8px;">
          <thead>
            <tr>
              <th>ID</th><th>Prov</th><th>Name</th><th>Mode</th><th>Resp</th><th>Reason</th><th>$in/1M</th><th>$out/1M</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Usage -->
    <div class="card">
      <h3>Recent Usage</h3>
      <div class="inline" style="margin-bottom:8px">
        <button id="refreshUsage" class="ghost">Refresh</button>
        <span class="muted">Last 200 rows</span>
      </div>
      <div class="table-wrap">
        <table id="usageTbl" style="margin-top:8px;">
          <thead>
            <tr>
              <th>ID</th><th>TS</th><th>Model</th><th>Conv</th><th>InTok</th><th>OutTok</th><th>Cost</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- LIVE PANE -->
  <div id="livePane" class="pane" style="display:none">
    <h2 style="margin:10px 0 12px">üì° Live Interactions</h2>

    <div class="card">
      <div class="inline" style="justify-content:space-between; margin-bottom:6px">
        <div class="inline">
          <span class="badge live">LIVE</span>
          <span class="muted">Streaming updates from the gateway</span>
        </div>
        <div class="inline">
          <button id="refreshRecent" class="ghost">Refresh Recent</button>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="t muted">Ongoing</div><div id="kOngoing" class="v">0</div></div>
        <div class="kpi"><div class="t muted">Last Finished</div><div id="kLast" class="v mono">‚Äì</div></div>
      </div>

      <h3 style="margin:10px 0 6px">Ongoing</h3>
      <div class="table-wrap">
        <table id="ongoingTbl">
          <thead>
            <tr>
              <th>ID</th><th>Model</th><th>Provider</th><th>InTok</th><th>OutChars</th><th>Started</th><th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <h3 style="margin:16px 0 6px">Recent (last 20)</h3>
      <div class="table-wrap">
        <table id="recentTbl">
          <thead>
            <tr>
              <th>Finished</th><th>ID</th><th>Model</th><th>Provider</th><th>InTok</th><th>OutTok</th><th>Cost</th><th>State</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* ---------- helpers ---------- */
const dot = document.getElementById('dot');
const healthText = document.getElementById('healthText');
function setBusy(b){ if(!dot||!healthText) return; dot.classList.toggle('on', b); healthText.textContent = b ? 'Checking‚Ä¶' : 'Idle'; }
const BASE = window.location.pathname.replace(/\/admin.*/, '');
const API_BASE = `${BASE}/api`;
const HEALTH_PATH = `${BASE}/health`;

const fmt = (n) => (n==null || Number.isNaN(n)) ? '' : String(n);
const isoToShort = (s) => {
  if (!s) return '';
  try { const d = new Date(s); return d.toLocaleString(); } catch { return s; }
};
function setBadge(el, state){
  el.className = 'badge';
  if (state === 'running') el.classList.add('live');
  else if (state === 'done') el.classList.add('done');
  else if (state === 'error') el.classList.add('error');
}

/* ---------- top tabs ---------- */
const tabs = document.querySelectorAll('.main-tabs .tab');
const adminPane = document.getElementById('adminPane');
const livePane  = document.getElementById('livePane');
tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  const which = t.getAttribute('data-tab');
  if (which === 'live') { adminPane.style.display = 'none'; livePane.style.display = 'block'; ensureSSE(); }
  else { livePane.style.display = 'none'; adminPane.style.display = 'block'; closeSSE(); }
}));

/* ---------- Health ---------- */
document.getElementById('healthBtn')?.addEventListener('click', async () => {
  try{
    setBusy(true);
    const r = await fetch(HEALTH_PATH);
    if (r.ok) { healthText.textContent = '‚úÖ Healthy'; dot.classList.add('on'); }
    else { healthText.textContent = '‚ùå Error'; dot.classList.remove('on'); }
  } catch {
    healthText.textContent = '‚ùå Unreachable'; dot.classList.remove('on');
  } finally {
    setTimeout(()=>{ if(healthText.textContent.startsWith('‚úÖ')||healthText.textContent.startsWith('‚ùå')) healthText.textContent='Idle'; }, 2000);
    setBusy(false);
  }
});

/* ---------- API helper ---------- */
async function api(path, method='GET', body) {
  const res = await fetch(`${API_BASE}${path}`, {
    method,
    headers:{'Content-Type':'application/json'},
    body: body ? JSON.stringify(body) : undefined
  });
  if (!res.ok) throw new Error(await res.text());
  return await res.json();
}

/* ---------- Providers ---------- */
const pName = document.getElementById('pName');
const pKind = document.getElementById('pKind');
const pBaseUrl = document.getElementById('pBaseUrl');
const pApiKey = document.getElementById('pApiKey');
const pHeaders = document.getElementById('pHeaders');
const saveProvider = document.getElementById('saveProvider');
const resetProvider = document.getElementById('resetProvider');

let editProviderId = null;
async function refreshProviders() {
  const data = await api('/providers');
  const tb = document.querySelector('#providersTbl tbody'); tb.innerHTML='';
  data.items.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.id}</td><td>${p.name}</td><td>${p.kind}</td><td class="mono">${p.base_url}</td>
      <td>
        <button class="ghost" data-edit="${p.id}">Edit</button>
        <button class="danger" data-del="${p.id}">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-edit]')?.forEach(b=> b.onclick = async () => {
    const id = b.getAttribute('data-edit'); const p = (await api(`/providers/${id}`)).provider;
    editProviderId = p.id;
    pName.value=p.name; pKind.value=p.kind; pBaseUrl.value=p.base_url; pApiKey.value=p.api_key||'';
    pHeaders.value = JSON.stringify(p.headers || {}, null, 2);
  });
  tb.querySelectorAll('button[data-del]')?.forEach(b=> b.onclick = async () => {
    const id = b.getAttribute('data-del'); if(!confirm('Delete provider?')) return;
    await api(`/providers/${id}`, 'DELETE'); refreshProviders();
  });
}
saveProvider.onclick = async () => {
  try {
    const body = {
      name:pName.value.trim(), kind:pKind.value,
      base_url:pBaseUrl.value.trim(),
      api_key:pApiKey.value.trim(),
      headers: pHeaders.value.trim() ? JSON.parse(pHeaders.value) : null
    };
    if (!body.name || !body.kind || !body.base_url) { alert('name, kind, base_url required'); return; }
    if (editProviderId) await api(`/providers/${editProviderId}`, 'PUT', body);
    else await api('/providers', 'POST', body);
    editProviderId = null;
    pName.value=''; pBaseUrl.value=''; pApiKey.value=''; pHeaders.value='{}';
    await refreshProviders();
  } catch (e) {
    alert(`Save failed: ${e.message}`);
  }
};
resetProvider.onclick = ()=>{ editProviderId=null; pName.value=''; pBaseUrl.value=''; pApiKey.value=''; pHeaders.value='{}'; };

/* ---------- Models ---------- */
const mProviderId = document.getElementById('mProviderId');
const mModelName = document.getElementById('mModelName');
const mKey = document.getElementById('mKey');
const mDisplayName = document.getElementById('mDisplayName');
const mMode = document.getElementById('mMode');
const mResp = document.getElementById('mResp');
const mReason = document.getElementById('mReason');
const mCurrency = document.getElementById('mCurrency');
const mInCost = document.getElementById('mInCost');
const mOutCost = document.getElementById('mOutCost');
const saveModel = document.getElementById('saveModel');
const resetModel = document.getElementById('resetModel');

let editModelId=null;
async function refreshModels() {
  const data = await api('/models');
  const tb = document.querySelector('#modelsTbl tbody'); tb.innerHTML='';
  data.items.forEach(m=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.id}</td><td>${m.provider_id}</td><td class="mono">${m.model_name}</td><td>${m.mode}</td>
      <td>${m.supports_responses}</td><td>${m.supports_reasoning}</td>
      <td>${m.input_cost_per_million}</td><td>${m.output_cost_per_million}</td>
      <td>
        <button class="ghost" data-edit="${m.id}">Edit</button>
        <button class="danger" data-del="${m.id}">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-edit]').forEach(b => b.onclick = async ()=>{
    const id = b.getAttribute('data-edit');
    const m = (await api(`/models/${id}`)).model;
    editModelId=m.id;
    mProviderId.value = m.provider_id; mModelName.value = m.model_name; mKey.value = m.key || '';
    mDisplayName.value = m.display_name || ''; mMode.value = m.mode || 'auto';
    mResp.value = m.supports_responses ? 'true' : 'false';
    mReason.value = m.supports_reasoning ? 'true' : 'false';
    mCurrency.value = m.currency || 'USD';
    mInCost.value = m.input_cost_per_million || 0;
    mOutCost.value = m.output_cost_per_million || 0;
  });
  tb.querySelectorAll('button[data-del]').forEach(b => b.onclick = async ()=>{
    const id = b.getAttribute('data-del'); if(!confirm('Delete model?')) return;
    await api(`/models/${id}`, 'DELETE'); refreshModels();
  });
}
saveModel.onclick = async ()=>{
  const body = {
    provider_id: Number(mProviderId.value), model_name: mModelName.value.trim(),
    key: mKey.value.trim() || null, display_name: mDisplayName.value.trim() || null,
    mode: mMode.value, supports_responses: mResp.value==='true', supports_reasoning: mReason.value==='true',
    input_cost_per_million: Number(mInCost.value), output_cost_per_million: Number(mOutCost.value),
    currency: mCurrency.value.trim() || 'USD'
  };
  if (!body.provider_id || !body.model_name) { alert('provider_id and model_name required'); return; }
  if (editModelId) await api(`/models/${editModelId}`, 'PUT', body);
  else await api('/models', 'POST', body);
  editModelId = null;
  mProviderId.value=''; mModelName.value=''; mKey.value=''; mDisplayName.value='';
  await refreshModels();
};
resetModel.onclick = ()=> { editModelId=null; mProviderId.value=''; mModelName.value=''; mKey.value=''; mDisplayName.value=''; };

/* ---------- Usage (Admin) ---------- */
async function refreshUsage() {
  const data = await api('/usage?limit=200');
  const tb = document.querySelector('#usageTbl tbody'); tb.innerHTML='';
  data.items.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.id}</td><td>${isoToShort(u.ts)}</td><td>${u.model_id || ''}</td>
                    <td>${u.conversation_id||''}</td><td>${u.input_tokens||''}</td>
                    <td>${u.output_tokens||''}</td><td>${u.cost||''}</td>`;
    tb.appendChild(tr);
  });
}
document.getElementById('refreshUsage').onclick = refreshUsage;

/* ---------- LIVE telemetry UI ---------- */
const kOngoing = document.getElementById('kOngoing');
const kLast    = document.getElementById('kLast');
const ongoingTBody = document.querySelector('#ongoingTbl tbody');
const recentTBody  = document.querySelector('#recentTbl tbody');
const refreshRecentBtn = document.getElementById('refreshRecent');

let sse; // EventSource
function closeSSE(){ if (sse) { try { sse.close(); } catch(_){} sse = null; } }
function ensureSSE(){
  if (sse) return;
  sse = new EventSource(`${API_BASE}/telemetry/live`);
  sse.onmessage = (ev) => {
    if (!ev.data) return;
    try {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'snapshot') {
        renderOngoing(msg.live || []);
        renderRecent(msg.recent || []);
      } else if (msg.type === 'started' || msg.type === 'updated') {
        upsertOngoing(msg.data);
      } else if (msg.type === 'finished') {
        removeOngoing(msg.data?.id);
        prependRecent(msg.data);
      }
    } catch (e) {}
  };
  sse.onerror = () => {
    // silent retry
    setTimeout(() => { closeSSE(); ensureSSE(); }, 2000);
  };
}

refreshRecentBtn.onclick = async () => {
  const r = await api('/telemetry/recent?limit=20');
  renderRecent(r.items || []);
};

/* render helpers */
function renderOngoing(items){
  ongoingTBody.innerHTML = '';
  (items||[]).forEach(i => {
    const tr = document.createElement('tr'); tr.dataset.id = i.id;
    tr.innerHTML = `
      <td class="mono">${i.id}</td>
      <td class="mono">${i.model || ''}</td>
      <td>${i.provider || ''}</td>
      <td>${fmt(i.in_tokens)}</td>
      <td>${fmt(i.out_chars)}</td>
      <td>${isoToShort(i.started_at)}</td>
      <td><span class="badge ${i.state==='running'?'live':(i.state==='error'?'error':'done')}">${i.state}</span></td>`;
    ongoingTBody.appendChild(tr);
  });
  kOngoing.textContent = String(items?.length || 0);
}
function upsertOngoing(i){
  if (!i || !i.id) return;
  let tr = ongoingTBody.querySelector(`tr[data-id="${i.id}"]`);
  if (!tr) {
    tr = document.createElement('tr'); tr.dataset.id = i.id;
    ongoingTBody.prepend(tr);
  }
  tr.innerHTML = `
    <td class="mono">${i.id}</td>
    <td class="mono">${i.model || ''}</td>
    <td>${i.provider || ''}</td>
    <td>${fmt(i.in_tokens)}</td>
    <td>${fmt(i.out_chars)}</td>
    <td>${isoToShort(i.started_at)}</td>
    <td><span class="badge ${i.state==='running'?'live':(i.state==='error'?'error':'done')}">${i.state}</span></td>`;
  kOngoing.textContent = String(ongoingTBody.querySelectorAll('tr').length);
}
function removeOngoing(id){
  if (!id) return;
  const tr = ongoingTBody.querySelector(`tr[data-id="${id}"]`);
  if (tr) tr.remove();
  kOngoing.textContent = String(ongoingTBody.querySelectorAll('tr').length);
}
function renderRecent(items){
  recentTBody.innerHTML = '';
  (items||[]).forEach(prependRecent);
}
function prependRecent(i){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${isoToShort(i.finished_at)}</td>
    <td class="mono">${i.id}</td>
    <td class="mono">${i.model || ''}</td>
    <td>${i.provider || ''}</td>
    <td>${fmt(i.in_tokens)}</td>
    <td>${fmt(i.out_tokens)}</td>
    <td>${i.cost != null ? '$'+Number(i.cost).toFixed(6) : ''}</td>
    <td><span class="badge ${i.state==='error'?'error':'done'}">${i.state}</span></td>`;
  recentTBody.prepend(tr);
  try { kLast.textContent = isoToShort(i.finished_at) || '‚Äì'; } catch {}
}

/* ---------- Boot ---------- */
(async function boot(){
  // default tab = Admin; fetch data
  refreshProviders(); refreshModels(); refreshUsage();
})();
</script>
</body>
</html>
