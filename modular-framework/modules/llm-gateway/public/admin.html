<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LLM Gateway Admin</title>
  <link rel="stylesheet" href="./css/theme.css" />
</head>
<body>
  <div class="header">
    <div class="inline">
      <span class="dot" id="dot"></span>
      <strong>LLM Gateway</strong>
      <span class="tab active">Admin</span>
    </div>
    <div class="grow"></div>
    <button id="healthBtn" class="ghost">Health Check</button>
    <span id="healthText" class="muted">Idle</span>
  </div>

  <div class="pane">
    <h2 style="margin:10px 0 12px">⚙️ LLM Gateway – Admin</h2>

    <!-- Providers -->
    <div class="card">
      <h3>Providers</h3>
      <div class="row">
        <div>
          <label>Name</label><input id="pName" placeholder="openai / together / ollama-local">
          <label>Kind</label>
          <select id="pKind">
            <option value="openai">openai</option>
            <option value="openai-compatible">openai-compatible</option>
            <option value="ollama">ollama</option>
          </select>
        </div>
        <div>
          <label>Base URL</label><input id="pBaseUrl" placeholder="https://api.openai.com">
          <label>API Key</label><input id="pApiKey" placeholder="sk-... (optional)">
        </div>
      </div>
      <label>Headers (JSON)</label>
      <textarea id="pHeaders" rows="3" placeholder='{"X-Client":"gw"}'></textarea>
      <div class="inline">
        <button id="saveProvider" class="btn">Save Provider</button>
        <button id="resetProvider" class="ghost">Reset</button>
      </div>
      <table id="providersTbl" style="width:100%; margin-top:8px; border-collapse:collapse">
        <thead>
          <tr>
            <th>ID</th><th>Name</th><th>Kind</th><th>Base URL</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Models -->
    <div class="card">
      <h3>Models</h3>
      <div class="row">
        <div>
          <label>Provider ID</label><input id="mProviderId" placeholder="e.g. 1">
          <label>Model name (upstream)</label><input id="mModelName" placeholder="gpt-4o-mini or gpt-5 or llama3">
        </div>
        <div>
          <label>Key (optional unique)</label><input id="mKey" placeholder="openai:gpt-4o-mini">
          <label>Display name</label><input id="mDisplayName" placeholder="GPT-4o Mini">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Mode</label>
          <select id="mMode">
            <option value="auto">auto</option>
            <option value="chat">chat</option>
            <option value="responses">responses</option>
          </select>
          <label>Supports responses</label>
          <select id="mResp">
            <option value="false">false</option>
            <option value="true">true</option>
          </select>
        </div>
        <div>
          <label>Supports reasoning</label>
          <select id="mReason">
            <option value="false">false</option>
            <option value="true">true</option>
          </select>
          <label>Currency</label><input id="mCurrency" value="USD">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Input cost per 1M tokens</label><input id="mInCost" type="number" step="0.000001" value="0">
        </div>
        <div>
          <label>Output cost per 1M tokens</label><input id="mOutCost" type="number" step="0.000001" value="0">
        </div>
      </div>
      <div class="inline">
        <button id="saveModel" class="btn">Save Model</button>
        <button id="resetModel" class="ghost">Reset</button>
      </div>
      <table id="modelsTbl" style="width:100%; margin-top:8px; border-collapse:collapse">
        <thead>
          <tr>
            <th>ID</th><th>Prov</th><th>Name</th><th>Mode</th><th>Resp</th><th>Reason</th><th>$in/1M</th><th>$out/1M</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Usage -->
    <div class="card">
      <h3>Recent Usage</h3>
      <div class="inline" style="margin-bottom:8px">
        <button id="refreshUsage" class="ghost">Refresh</button>
        <span class="muted">Last 200 rows</span>
      </div>
      <table id="usageTbl" style="width:100%; margin-top:8px; border-collapse:collapse">
        <thead>
          <tr>
            <th>ID</th><th>TS</th><th>Model</th><th>Conv</th><th>InTok</th><th>OutTok</th><th>Cost</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
/* Small status helpers */
const dot = document.getElementById('dot');
const healthText = document.getElementById('healthText');
function setBusy(b){ if(!dot||!healthText) return; dot.classList.toggle('on', b); healthText.textContent = b ? 'Checking…' : 'Idle'; }
const BASE = window.location.pathname.replace(/\/admin.*/, '');
const API_BASE = `${BASE}/api`;
//const API_BASE = `${BASE}/api`;   // "/api" when BASE == "", else "/api/v1/gateway/"
const HEALTH_PATH = `${BASE}/health`;

const pName = document.getElementById('pName');
const pKind = document.getElementById('pKind');
const pBaseUrl = document.getElementById('pBaseUrl');
const pApiKey = document.getElementById('pApiKey');
const pHeaders = document.getElementById('pHeaders');
const saveProvider = document.getElementById('saveProvider');
const resetProvider = document.getElementById('resetProvider');

const mProviderId = document.getElementById('mProviderId');
const mModelName = document.getElementById('mModelName');
const mKey = document.getElementById('mKey');
const mDisplayName = document.getElementById('mDisplayName');
const mMode = document.getElementById('mMode');
const mResp = document.getElementById('mResp');
const mReason = document.getElementById('mReason');
const mCurrency = document.getElementById('mCurrency');
const mInCost = document.getElementById('mInCost');
const mOutCost = document.getElementById('mOutCost');

const saveModel = document.getElementById('saveModel');
const resetModel = document.getElementById('resetModel');


/* API helper */
async function api(path, method='GET', body) {
  const res = await fetch(`${API_BASE}${path}`, {
    method,
    headers:{'Content-Type':'application/json'},
    body: body ? JSON.stringify(body) : undefined
  });
  if (!res.ok) throw new Error(await res.text());
  return await res.json();
}


/* Health check */
document.getElementById('healthBtn')?.addEventListener('click', async () => {
  try{
    setBusy(true);
    const r = await fetch(HEALTH_PATH);
    if (r.ok) { healthText.textContent = '✅ Healthy'; dot.classList.add('on'); }
    else { healthText.textContent = '❌ Error'; dot.classList.remove('on'); }
  } catch {
    healthText.textContent = '❌ Unreachable'; dot.classList.remove('on');
  } finally {
    setTimeout(()=>{ if(healthText.textContent.startsWith('✅')||healthText.textContent.startsWith('❌')) healthText.textContent='Idle'; }, 2000);
    setBusy(false);
  }
});

/* Providers */
let editProviderId = null;
async function refreshProviders() {
  const data = await api('/providers');
  const tb = document.querySelector('#providersTbl tbody'); tb.innerHTML='';
  data.items.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.id}</td><td>${p.name}</td><td>${p.kind}</td><td>${p.base_url}</td>
      <td>
        <button class="ghost" data-edit="${p.id}">Edit</button>
        <button class="danger" data-del="${p.id}">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-edit]')?.forEach(b=> b.onclick = async () => {
    const id = b.getAttribute('data-edit'); const p = (await api(`/providers/${id}`)).provider;
    editProviderId = p.id;
    pName.value=p.name; pKind.value=p.kind; pBaseUrl.value=p.base_url; pApiKey.value=p.api_key||'';
    pHeaders.value = JSON.stringify(p.headers || {}, null, 2);
  });
  tb.querySelectorAll('button[data-del]')?.forEach(b=> b.onclick = async () => {
    const id = b.getAttribute('data-del'); if(!confirm('Delete provider?')) return;
    await api(`/providers/${id}`, 'DELETE'); refreshProviders();
  });
}
saveProvider.onclick = async () => {
  try {
    const body = {
      name:pName.value.trim(), kind:pKind.value,
      base_url:pBaseUrl.value.trim(),
      api_key:pApiKey.value.trim(),
      headers: pHeaders.value.trim() ? JSON.parse(pHeaders.value) : null
    };
    if (!body.name || !body.kind || !body.base_url) { alert('name, kind, base_url required'); return; }
    if (editProviderId) await api(`/providers/${editProviderId}`, 'PUT', body);
    else await api('/providers', 'POST', body);
    editProviderId = null;
    pName.value=''; pBaseUrl.value=''; pApiKey.value=''; pHeaders.value='{}';
    await refreshProviders();
  } catch (e) {
    alert(`Save failed: ${e.message}`);
  }
};
resetProvider.onclick = ()=>{ editProviderId=null; pName.value=''; pBaseUrl.value=''; pApiKey.value=''; pHeaders.value='{}'; };

/* Models */
let editModelId=null;
async function refreshModels() {
  const data = await api('/models');
  const tb = document.querySelector('#modelsTbl tbody'); tb.innerHTML='';
  data.items.forEach(m=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.id}</td><td>${m.provider_id}</td><td>${m.model_name}</td><td>${m.mode}</td>
      <td>${m.supports_responses}</td><td>${m.supports_reasoning}</td>
      <td>${m.input_cost_per_million}</td><td>${m.output_cost_per_million}</td>
      <td>
        <button class="ghost" data-edit="${m.id}">Edit</button>
        <button class="danger" data-del="${m.id}">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-edit]').forEach(b => b.onclick = async ()=>{
    const id = b.getAttribute('data-edit');
    const m = (await api(`/models/${id}`)).model;
    editModelId=m.id;
    mProviderId.value = m.provider_id; mModelName.value = m.model_name; mKey.value = m.key || '';
    mDisplayName.value = m.display_name || ''; mMode.value = m.mode || 'auto';
    mResp.value = m.supports_responses ? 'true' : 'false';
    mReason.value = m.supports_reasoning ? 'true' : 'false';
    mCurrency.value = m.currency || 'USD';
    mInCost.value = m.input_cost_per_million || 0;
    mOutCost.value = m.output_cost_per_million || 0;
  });
  tb.querySelectorAll('button[data-del]').forEach(b => b.onclick = async ()=>{
    const id = b.getAttribute('data-del'); if(!confirm('Delete model?')) return;
    await api(`/models/${id}`, 'DELETE'); refreshModels();
  });
}
saveModel.onclick = async ()=>{
  const body = {
    provider_id: Number(mProviderId.value), model_name: mModelName.value.trim(),
    key: mKey.value.trim() || null, display_name: mDisplayName.value.trim() || null,
    mode: mMode.value, supports_responses: mResp.value==='true', supports_reasoning: mReason.value==='true',
    input_cost_per_million: Number(mInCost.value), output_cost_per_million: Number(mOutCost.value),
    currency: mCurrency.value.trim() || 'USD'
  };
  if (!body.provider_id || !body.model_name) { alert('provider_id and model_name required'); return; }
  if (editModelId) await api(`/models/${editModelId}`, 'PUT', body);
  else await api('/models', 'POST', body);
  editModelId = null;
  mProviderId.value=''; mModelName.value=''; mKey.value=''; mDisplayName.value='';
  await refreshModels();
};
resetModel.onclick = ()=> { editModelId=null; mProviderId.value=''; mModelName.value=''; mKey.value=''; mDisplayName.value=''; };

/* Usage */
async function refreshUsage() {
  const data = await api('/usage?limit=200');
  const tb = document.querySelector('#usageTbl tbody'); tb.innerHTML='';
  data.items.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.id}</td><td>${u.ts}</td><td>${u.model_id || ''}</td>
                    <td>${u.conversation_id||''}</td><td>${u.input_tokens||''}</td>
                    <td>${u.output_tokens||''}</td><td>${u.cost||''}</td>`;
    tb.appendChild(tr);
  });
}
document.getElementById('refreshUsage').onclick = refreshUsage;

/* Boot */
refreshProviders(); refreshModels(); refreshUsage();
</script>
</body>
</html>
