<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>LLM Gateway Admin</title>
  <base href="/api/v1/gateway/">
  <link rel="stylesheet" href="./css/theme.css" />
</head>
<body>
  <div class="header">
    <div class="inline">
      <span class="dot" id="dot"></span>
      <strong>LLM Gateway</strong>
      <span class="tab active" id="tabAdmin">Admin</span>
      <span class="tab" id="tabConversations">Conversations</span>
      <span class="tab" id="tabTemplates">Templates</span>
      <span class="tab" id="tabLive">Live</span>
      <span class="tab" id="tabDebug">Debug</span>
    </div>
    <div class="grow"></div>
    <button id="healthBtn" class="ghost">Health Check</button>
    <span id="healthText" class="muted">Idle</span>
  </div>

  <!-- Admin pane -->
  <div class="pane" id="adminPane">
    <h2 style="margin:10px 0 12px">‚öôÔ∏è LLM Gateway ‚Äì Admin</h2>

    <!-- Providers -->
    <div class="card">
      <h3>Providers</h3>
      <div class="row">
        <div>
          <label>Name</label><input id="pName" placeholder="openai / together / ollama-local">
          <label>Kind</label>
          <select id="pKind">
            <option value="openai">openai</option>
            <option value="openai-compatible">openai-compatible</option>
            <option value="ollama">ollama</option>
          </select>
        </div>
        <div>
          <label>Base URL</label><input id="pBaseUrl" placeholder="https://api.openai.com">
          <label>API Key</label><input id="pApiKey" placeholder="sk-... (optional)">
        </div>
      </div>
      <label>Headers (JSON)</label>
      <textarea id="pHeaders" rows="3" placeholder='{"X-Client":"gw"}'></textarea>
      <div class="inline">
        <button id="saveProvider" class="btn">Save Provider</button>
        <button id="resetProvider" class="ghost">Reset</button>
      </div>
      <table id="providersTbl" style="width:100%; margin-top:8px; border-collapse:collapse">
        <thead>
          <tr>
            <th>ID</th><th>Name</th><th>Kind</th><th>Base URL</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Models -->
    <div class="card">
      <h3>Models</h3>
      <div class="row">
        <div>
          <label>Provider ID</label><input id="mProviderId" placeholder="e.g. 1">
          <label>Model name (upstream)</label><input id="mModelName" placeholder="gpt-4o-mini or gpt-5 or llama3">
        </div>
        <div>
          <label>Key (optional unique)</label><input id="mKey" placeholder="openai:gpt-4o-mini">
          <label>Display name</label><input id="mDisplayName" placeholder="GPT-4o Mini">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Mode</label>
          <select id="mMode">
            <option value="auto">auto</option>
            <option value="chat">chat</option>
            <option value="responses">responses</option>
          </select>
          <label>Supports responses</label>
          <select id="mResp">
            <option value="false">false</option>
            <option value="true">true</option>
          </select>
        </div>
        <div>
          <label>Supports reasoning</label>
          <select id="mReason">
            <option value="false">false</option>
            <option value="true">true</option>
          </select>
          <label>Currency</label><input id="mCurrency" value="USD">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Input cost per 1M tokens</label><input id="mInCost" type="number" step="0.000001" value="0">
        </div>
        <div>
          <label>Output cost per 1M tokens</label><input id="mOutCost" type="number" step="0.000001" value="0">
        </div>
      </div>
      <div class="inline">
        <button id="saveModel" class="btn">Save Model</button>
        <button id="resetModel" class="ghost">Reset</button>
      </div>
      <table id="modelsTbl" style="width:100%; margin-top:8px; border-collapse:collapse">
        <thead>
          <tr>
            <th>ID</th><th>Prov</th><th>Name</th><th>Mode</th><th>Resp</th><th>Reason</th><th>$in/1M</th><th>$out/1M</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Usage -->
    <div class="card">
      <h3>Recent Usage</h3>
      <div class="inline" style="margin-bottom:8px">
        <button id="refreshUsage" class="ghost">Refresh</button>
        <span class="muted">Last 200 rows</span>
      </div>
      <table id="usageTbl" style="width:100%; margin-top:8px; border-collapse:collapse">
        <thead>
          <tr>
            <th>ID</th><th>TS</th><th>Model</th><th>Conv</th><th>InTok</th><th>OutTok</th><th>Cost</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Conversations pane -->
  <div class="pane" id="conversationsPane" style="display:none">
    <h2 style="margin:10px 0 12px">üí¨ Conversations</h2>
    <div class="card">
      <div class="row-live" style="margin-bottom:10px">
        <div class="inline">
          <input id="convSearch" placeholder="Search by title or ID" style="width:300px">
          <button id="searchConv" class="ghost">Search</button>
          <button id="newConv" class="btn">New Conversation</button>
        </div>
        <button id="refreshConv" class="ghost">Refresh</button>
      </div>
      <div id="convList" class="list"></div>
    </div>
  </div>

  <!-- Templates pane -->
  <div class="pane" id="templatesPane" style="display:none">
    <h2 style="margin:10px 0 12px">üìù Prompt Templates</h2>
    <div class="card">
      <div class="row">
        <div>
          <label>Name</label><input id="tName" placeholder="customer-support-greeting">
          <label>Description</label><input id="tDesc" placeholder="Template for greeting customers">
        </div>
        <div>
          <label>Tags (comma-separated)</label><input id="tTags" placeholder="support, greeting">
        </div>
      </div>
      <label>Template (use {{variable}} syntax)</label>
      <textarea id="tTemplate" rows="6" placeholder="Hello {{customer_name}}, how can I help you today?"></textarea>
      <div class="inline">
        <button id="saveTemplate" class="btn">Save Template</button>
        <button id="resetTemplate" class="ghost">Reset</button>
        <button id="testTemplate" class="ghost">Test</button>
      </div>
      <table id="templatesTbl" style="width:100%; margin-top:8px; border-collapse:collapse">
        <thead>
          <tr>
            <th>ID</th><th>Name</th><th>Version</th><th>Description</th><th>Usage</th><th>Avg Cost</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Live pane (unchanged) -->
  <div class="pane" id="livePane" style="display:none">
    <h2 style="margin:10px 0 12px">üì° Live LLM Interactions</h2>
    <div class="card">
      <div class="row-live" style="margin-bottom:10px">
        <div class="inline">
          <label style="margin:0 8px 0 0">Scope</label>
          <select id="scopeSel">
            <option value="live">Live</option>
            <option value="conversation">Conversation</option>
          </select>
          <input id="convId" placeholder="conversation_id" style="width:320px; margin-left:8px">
          <button id="followBtn" class="ghost">Follow latest</button>
        </div>
        <div class="tiny">Subscribed to <code class="mono" id="sseUrlTxt"></code></div>
      </div>
      <div class="two-cols">
        <div>
          <label>Interactions</label>
          <div id="liveList" class="list list-scroll"></div>
        </div>
        <div>
          <div class="row-live" style="margin-bottom:6px">
            <label class="inline">Transcript</label>
            <div class="inline">
              <button id="copyTranscript" class="copy-btn">Copy transcript</button>
            </div>
          </div>
          <div id="detail" style="min-height:180px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Debug pane -->
  <div class="pane" id="debugPane" style="display:none">
    <h2 style="margin:10px 0 12px">üîß Debug Tools</h2>
    
    <div class="card">
      <h3>Dry-Run Test</h3>
      <p class="muted">Test a request without calling the LLM (validates and estimates cost)</p>
      <div class="row">
        <div>
          <label>Model ID</label><input id="dryModelId" placeholder="1" type="number">
        </div>
        <div>
          <label>Temperature</label><input id="dryTemp" placeholder="0.7" type="number" step="0.1">
        </div>
      </div>
      <label>Messages (JSON)</label>
      <textarea id="dryMessages" rows="6" placeholder='[{"role":"user","content":"Hello"}]'></textarea>
      <button id="runDryRun" class="btn">Run Dry-Run</button>
      <div id="dryResult" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h3>Replay Request</h3>
      <p class="muted">Replay a previous request from usage log</p>
      <label>Usage Log ID</label>
      <input id="replayId" placeholder="123" type="number">
      <button id="runReplay" class="btn">Replay</button>
      <div id="replayResult" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h3>Validate Request</h3>
      <p class="muted">Check request structure without processing</p>
      <label>Request Body (JSON)</label>
      <textarea id="validateBody" rows="6" placeholder='{"model_id":1,"messages":[...]}'></textarea>
      <button id="runValidate" class="btn">Validate</button>
      <div id="validateResult" style="margin-top:10px"></div>
    </div>
  </div>

<script>
/* Status helpers */
const dot = document.getElementById('dot');
const healthText = document.getElementById('healthText');
function setBusy(b){ if(!dot||!healthText) return; dot.classList.toggle('on', b); healthText.textContent = b ? 'Checking‚Ä¶' : 'Idle'; }
const BASE = window.location.pathname.replace(/\/admin.*/, '');
const API_BASE = `${BASE}/api`;
const HEALTH_PATH = `${BASE}/health`;

/* Tabs */
const tabs = {
  admin: { btn: document.getElementById('tabAdmin'), pane: document.getElementById('adminPane') },
  conversations: { btn: document.getElementById('tabConversations'), pane: document.getElementById('conversationsPane') },
  templates: { btn: document.getElementById('tabTemplates'), pane: document.getElementById('templatesPane') },
  live: { btn: document.getElementById('tabLive'), pane: document.getElementById('livePane') },
  debug: { btn: document.getElementById('tabDebug'), pane: document.getElementById('debugPane') }
};

function showTab(name) {
  Object.entries(tabs).forEach(([k, t]) => {
    if (k === name) {
      t.btn.classList.add('active');
      t.pane.style.display = 'block';
      if (k === 'live') ensureSSE();
    } else {
      t.btn.classList.remove('active');
      t.pane.style.display = 'none';
    }
  });
}

tabs.admin.btn?.addEventListener('click', () => showTab('admin'));
tabs.conversations.btn?.addEventListener('click', () => { showTab('conversations'); refreshConversations(); });
tabs.templates.btn?.addEventListener('click', () => { showTab('templates'); refreshTemplates(); });
tabs.live.btn?.addEventListener('click', () => showTab('live'));
tabs.debug.btn?.addEventListener('click', () => showTab('debug'));

/* API helper */
async function api(path, method='GET', body) {
  const res = await fetch(`${API_BASE}${path}`, {
    method,
    headers:{'Content-Type':'application/json'},
    body: body ? JSON.stringify(body) : undefined
  });
  if (!res.ok) throw new Error(await res.text());
  return await res.json();
}

/* Health check */
document.getElementById('healthBtn')?.addEventListener('click', async () => {
  try{
    setBusy(true);
    const r = await fetch(HEALTH_PATH);
    if (r.ok) { healthText.textContent = '‚úÖ Healthy'; dot.classList.add('on'); }
    else { healthText.textContent = '‚ùå Error'; dot.classList.remove('on'); }
  } catch {
    healthText.textContent = '‚ùå Unreachable'; dot.classList.remove('on');
  } finally {
    setTimeout(()=>{ if(healthText.textContent.startsWith('‚úÖ')||healthText.textContent.startsWith('‚ùå')) healthText.textContent='Idle'; }, 2000);
    setBusy(false);
  }
});

/* Providers (existing code unchanged) */
const pName = document.getElementById('pName');
const pKind = document.getElementById('pKind');
const pBaseUrl = document.getElementById('pBaseUrl');
const pApiKey = document.getElementById('pApiKey');
const pHeaders = document.getElementById('pHeaders');
const saveProvider = document.getElementById('saveProvider');
const resetProvider = document.getElementById('resetProvider');

let editProviderId = null;
async function refreshProviders() {
  const data = await api('/providers');
  const tb = document.querySelector('#providersTbl tbody'); tb.innerHTML='';
  data.items.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.id}</td><td>${p.name}</td><td>${p.kind}</td><td>${p.base_url}</td>
      <td>
        <button class="ghost" data-edit="${p.id}">Edit</button>
        <button class="danger" data-del="${p.id}">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-edit]')?.forEach(b=> b.onclick = async () => {
    const id = b.getAttribute('data-edit'); const p = (await api(`/providers/${id}`)).provider;
    editProviderId = p.id;
    pName.value=p.name; pKind.value=p.kind; pBaseUrl.value=p.base_url; pApiKey.value=p.api_key||'';
    pHeaders.value = JSON.stringify(p.headers || {}, null, 2);
  });
  tb.querySelectorAll('button[data-del]')?.forEach(b=> b.onclick = async () => {
    const id = b.getAttribute('data-del'); if(!confirm('Delete provider?')) return;
    await api(`/providers/${id}`, 'DELETE'); refreshProviders();
  });
}
saveProvider.onclick = async () => {
  try {
    const body = {
      name:pName.value.trim(), kind:pKind.value,
      base_url:pBaseUrl.value.trim(),
      api_key:pApiKey.value.trim(),
      headers: pHeaders.value.trim() ? JSON.parse(pHeaders.value) : null
    };
    if (!body.name || !body.kind || !body.base_url) { alert('name, kind, base_url required'); return; }
    if (editProviderId) await api(`/providers/${editProviderId}`, 'PUT', body);
    else await api('/providers', 'POST', body);
    editProviderId = null;
    pName.value=''; pBaseUrl.value=''; pApiKey.value=''; pHeaders.value='{}';
    await refreshProviders();
  } catch (e) {
    alert(`Save failed: ${e.message}`);
  }
};
resetProvider.onclick = ()=>{ editProviderId=null; pName.value=''; pBaseUrl.value=''; pApiKey.value=''; pHeaders.value='{}'; };

/* Models (existing code unchanged) */
const mProviderId = document.getElementById('mProviderId');
const mModelName = document.getElementById('mModelName');
const mKey = document.getElementById('mKey');
const mDisplayName = document.getElementById('mDisplayName');
const mMode = document.getElementById('mMode');
const mResp = document.getElementById('mResp');
const mReason = document.getElementById('mReason');
const mCurrency = document.getElementById('mCurrency');
const mInCost = document.getElementById('mInCost');
const mOutCost = document.getElementById('mOutCost');
const saveModel = document.getElementById('saveModel');
const resetModel = document.getElementById('resetModel');

let editModelId=null;
async function refreshModels() {
  const data = await api('/models');
  const tb = document.querySelector('#modelsTbl tbody'); tb.innerHTML='';
  data.items.forEach(m=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.id}</td><td>${m.provider_id}</td><td>${m.model_name}</td><td>${m.mode}</td>
      <td>${m.supports_responses}</td><td>${m.supports_reasoning}</td>
      <td>${m.input_cost_per_million}</td><td>${m.output_cost_per_million}</td>
      <td>
        <button class="ghost" data-edit="${m.id}">Edit</button>
        <button class="danger" data-del="${m.id}">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-edit]').forEach(b => b.onclick = async ()=>{
    const id = b.getAttribute('data-edit');
    const m = (await api(`/models/${id}`)).model;
    editModelId=m.id;
    mProviderId.value = m.provider_id; mModelName.value = m.model_name; mKey.value = m.key || '';
    mDisplayName.value = m.display_name || ''; mMode.value = m.mode || 'auto';
    mResp.value = m.supports_responses ? 'true' : 'false';
    mReason.value = m.supports_reasoning ? 'true' : 'false';
    mCurrency.value = m.currency || 'USD';
    mInCost.value = m.input_cost_per_million || 0;
    mOutCost.value = m.output_cost_per_million || 0;
  });
  tb.querySelectorAll('button[data-del]').forEach(b => b.onclick = async ()=>{
    const id = b.getAttribute('data-del'); if(!confirm('Delete model?')) return;
    await api(`/models/${id}`, 'DELETE'); refreshModels();
  });
}
saveModel.onclick = async ()=>{
  const body = {
    provider_id: Number(mProviderId.value), model_name: mModelName.value.trim(),
    key: mKey.value.trim() || null, display_name: mDisplayName.value.trim() || null,
    mode: mMode.value, supports_responses: mResp.value==='true', supports_reasoning: mReason.value==='true',
    input_cost_per_million: Number(mInCost.value), output_cost_per_million: Number(mOutCost.value),
    currency: mCurrency.value.trim() || 'USD'
  };
  if (!body.provider_id || !body.model_name) { alert('provider_id and model_name required'); return; }
  if (editModelId) await api(`/models/${editModelId}`, 'PUT', body);
  else await api('/models', 'POST', body);
  editModelId = null;
  mProviderId.value=''; mModelName.value=''; mKey.value=''; mDisplayName.value='';
  await refreshModels();
};
resetModel.onclick = ()=> { editModelId=null; mProviderId.value=''; mModelName.value=''; mKey.value=''; mDisplayName.value=''; };

/* Usage */
async function refreshUsage() {
  const data = await api('/usage?limit=200');
  const tb = document.querySelector('#usageTbl tbody'); tb.innerHTML='';
  data.items.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.id}</td><td>${u.ts}</td><td>${u.model_id || ''}</td>
                    <td>${u.conversation_id||''}</td><td>${u.input_tokens||''}</td>
                    <td>${u.output_tokens||''}</td><td>${u.cost||''}</td>`;
    tb.appendChild(tr);
  });
}
document.getElementById('refreshUsage').onclick = refreshUsage;

/* Conversations */
async function refreshConversations() {
  const search = document.getElementById('convSearch').value.trim();
  const url = `/conversations?limit=50${search ? `&search=${encodeURIComponent(search)}` : ''}`;
  const data = await api(url);
  const list = document.getElementById('convList');
  list.innerHTML = '';
  data.items.forEach(c => {
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `
      <div>
        <strong>${c.title || c.id}</strong>
        <div class="tiny">${c.message_count || 0} messages ¬∑ Model: ${c.model_name || 'none'}</div>
      </div>
      <div class="inline">
        <button class="ghost" data-view="${c.id}">View</button>
        <button class="danger" data-archive="${c.id}">Archive</button>
      </div>
    `;
    list.appendChild(el);
  });
  list.querySelectorAll('button[data-view]').forEach(b => b.onclick = async () => {
    const id = b.getAttribute('data-view');
    const conv = (await api(`/conversations/${id}`)).conversation;
    const msgs = (await api(`/conversations/${id}/messages?limit=100`)).items;
    alert(`Conversation: ${conv.title || conv.id}\n\n${msgs.map(m => `${m.role}: ${m.content?.slice(0,100)}...`).join('\n\n')}`);
  });
  list.querySelectorAll('button[data-archive]').forEach(b => b.onclick = async () => {
    const id = b.getAttribute('data-archive');
    if (!confirm('Archive conversation?')) return;
    await api(`/conversations/${id}`, 'PUT', { archived: true });
    refreshConversations();
  });
}
document.getElementById('refreshConv')?.addEventListener('click', refreshConversations);
document.getElementById('searchConv')?.addEventListener('click', refreshConversations);
document.getElementById('newConv')?.addEventListener('click', () => {
  const id = prompt('Conversation ID:');
  const title = prompt('Title (optional):');
  if (!id) return;
  api('/conversations', 'POST', { id, title }).then(() => refreshConversations());
});

/* Templates */
const tName = document.getElementById('tName');
const tDesc = document.getElementById('tDesc');
const tTags = document.getElementById('tTags');
const tTemplate = document.getElementById('tTemplate');

let editTemplateId = null;
async function refreshTemplates() {
  const data = await api('/templates');
  const tb = document.querySelector('#templatesTbl tbody'); tb.innerHTML='';
  data.items.forEach(t => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.id}</td><td>${t.name}</td><td>${t.version}</td><td>${t.description||''}</td>
      <td>${t.usage_count||0}</td><td>${t.avg_cost||0}</td>
      <td>
        <button class="ghost" data-edit="${t.id}">Edit</button>
        <button class="danger" data-del="${t.id}">Delete</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-edit]').forEach(b => b.onclick = async () => {
    const id = b.getAttribute('data-edit');
    const t = (await api(`/templates/${id}`)).template;
    editTemplateId = t.id;
    tName.value = t.name; tDesc.value = t.description || ''; 
    tTemplate.value = t.template;
    tTags.value = (t.tags || []).join(', ');
  });
  tb.querySelectorAll('button[data-del]').forEach(b => b.onclick = async () => {
    const id = b.getAttribute('data-del');
    if (!confirm('Delete template?')) return;
    await api(`/templates/${id}`, 'DELETE');
    refreshTemplates();
  });
}
document.getElementById('saveTemplate').onclick = async () => {
  const body = {
    name: tName.value.trim(),
    description: tDesc.value.trim(),
    template: tTemplate.value.trim(),
    tags: tTags.value.split(',').map(t => t.trim()).filter(Boolean)
  };
  if (!body.name || !body.template) { alert('name and template required'); return; }
  if (editTemplateId) await api(`/templates/${editTemplateId}`, 'PUT', body);
  else await api('/templates', 'POST', body);
  editTemplateId = null;
  tName.value = ''; tDesc.value = ''; tTemplate.value = ''; tTags.value = '';
  refreshTemplates();
};
document.getElementById('resetTemplate').onclick = () => {
  editTemplateId = null;
  tName.value = ''; tDesc.value = ''; tTemplate.value = ''; tTags.value = '';
};
document.getElementById('testTemplate').onclick = async () => {
  const vars = prompt('Template variables (JSON):');
  if (!vars) return;
  const body = { variables: JSON.parse(vars) };
  const result = await api(`/templates/${editTemplateId}/render`, 'POST', body);
  alert('Rendered:\n\n' + result.rendered);
};

/* Debug tools */
document.getElementById('runDryRun').onclick = async () => {
  const msgs = JSON.parse(document.getElementById('dryMessages').value || '[]');
  const body = {
    model_id: Number(document.getElementById('dryModelId').value),
    messages: msgs,
    temperature: Number(document.getElementById('dryTemp').value) || 0.7,
    dry_run: true
  };
  try {
    const result = await api('/v1/chat?dry_run=1', 'POST', body);
    document.getElementById('dryResult').innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
  } catch (e) {
    document.getElementById('dryResult').innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
  }
};

document.getElementById('runReplay').onclick = async () => {
  const id = document.getElementById('replayId').value;
  try {
    const result = await api(`/debug/replay/${id}`, 'POST');
    document.getElementById('replayResult').innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
  } catch (e) {
    document.getElementById('replayResult').innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
  }
};

document.getElementById('runValidate').onclick = async () => {
  const body = JSON.parse(document.getElementById('validateBody').value || '{}');
  try {
    const result = await api('/debug/validate', 'POST', body);
    document.getElementById('validateResult').innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
  } catch (e) {
    document.getElementById('validateResult').innerHTML = `<div style="color:red">Error: ${e.message}</div>`;
  }
};

/* Live telemetry (existing code unchanged) */
const sseUrlTxt = document.getElementById('sseUrlTxt');
const scopeSel = document.getElementById('scopeSel');
const convId = document.getElementById('convId');
const followBtn = document.getElementById('followBtn');
const liveList = document.getElementById('liveList');
const detail = document.getElementById('detail');
const copyTranscript = document.getElementById('copyTranscript');

let es = null;
let itemsById = new Map();
let selectedId = null;
let followLatest = true;

followBtn.onclick = () => { followLatest = !followLatest; followBtn.textContent = followLatest ? 'Follow latest' : 'Manual'; };

function ensureSSE() {
  const url = `${API_BASE}/telemetry/live`;
  sseUrlTxt.textContent = url.replace(location.origin, '');
  if (es) return;
  es = new EventSource(url);
  es.onmessage = (ev) => {
    const msg = JSON.parse(ev.data);
    if (msg.type === 'snapshot') {
      itemsById = new Map();
      (msg.live || []).forEach(addOrUpdate);
      (msg.recent || []).forEach(addOrUpdate);
      renderList();
      if (followLatest) autoSelectLatest();
      return;
    }
    if (msg.type === 'started' || msg.type === 'updated' || msg.type === 'finished') {
      addOrUpdate(msg.data);
      renderList();
      if (followLatest) autoSelectLatest();
      if (selectedId) renderDetail(selectedId);
    }
  };
  es.onerror = () => { /* auto-reconnect */ };
}

function addOrUpdate(rec) {
  if (!rec || !rec.id) return;
  const existing = itemsById.get(rec.id) || {};
  itemsById.set(rec.id, { ...existing, ...rec });
}

function filterMatches(rec) {
  const scope = scopeSel.value;
  if (scope === 'conversation') {
    const want = convId.value.trim();
    if (!want) return false;
    const has = rec?.meta?.conversation_id || rec?.conversation_id;
    return has === want;
  }
  return true;
}

function renderList() {
  const arr = Array.from(itemsById.values())
    .sort((a,b) => String(b.started_at||'').localeCompare(String(a.started_at||'')));
  liveList.innerHTML = '';
  for (const r of arr) {
    if (!filterMatches(r)) continue;
    const el = document.createElement('div');
    el.className = 'item';
    el.style.cursor = 'pointer';
    const status = r.state === 'done' ? '‚úÖ' : (r.state === 'error' ? '‚ùå' : '‚è≥');
    const conv = (r.meta && r.meta.conversation_id) ? ` ¬∑ conv:${r.meta.conversation_id}` : '';
    el.innerHTML = `
      <div class="w-clip">
        <span class="pill">${status}</span>
        <span class="tiny">${r.started_at?.slice(11,19) || ''}</span>
        <strong>${r.model || ''}</strong> <span class="tiny">(${r.provider || ''})</span>
        <span class="tiny">${conv}</span>
      </div>
      <div class="tiny">${(r.output || '').length} chars</div>
    `;
    el.onclick = ()=>{ selectedId = r.id; renderDetail(selectedId); };
    liveList.appendChild(el);
  }
}

function renderDetail(id) {
  const r = itemsById.get(id);
  if (!r) { detail.innerHTML = '<div class="tiny">No details</div>'; return; }
  const msgs = Array.isArray(r.messages) ? r.messages : [];
  const bubbles = msgs.map(m => `<div class="bubble ${m.role==='assistant'?'assistant':'user'}"><div class="tiny">${m.role}</div>${escapeHtml(m.content||'')}</div>`).join('');
  const out = r.output ? `<div class="bubble assistant"><div class="tiny">assistant (live)</div>${escapeHtml(r.output)}</div>` : '';
  const head = `
    <div class="tiny" style="margin-bottom:6px">
      <strong>ID</strong> ${r.id} ¬∑ <strong>Model</strong> ${r.model||''} (${r.provider||''})
      ${r.meta?.conversation_id ? ' ¬∑ <strong>conversation_id</strong> '+r.meta.conversation_id : ''}
      ${typeof r.inTok==='number' ? ' ¬∑ <strong>inTok</strong> '+r.inTok : ''}
      ${typeof r.outTok==='number' ? ' ¬∑ <strong>outTok</strong> '+r.outTok : ''}
      ${typeof r.cost==='number' ? ' ¬∑ <strong>cost</strong> $'+r.cost : ''}
    </div>`;
  detail.innerHTML = head + bubbles + out;
  detail.scrollTop = detail.scrollHeight;
}

function autoSelectLatest() {
  const arr = Array.from(itemsById.values())
    .filter(filterMatches)
    .sort((a,b) => String(b.started_at||'').localeCompare(String(a.started_at||'')));
  if (arr.length) { selectedId = arr[0].id; renderDetail(selectedId); }
}

copyTranscript.onclick = async () => {
  const r = itemsById.get(selectedId);
  if (!r) return;
  const msgs = Array.isArray(r.messages) ? r.messages : [];
  const lines = [];
  msgs.forEach(m => lines.push(`${m.role}: ${m.content||''}`));
  if (r.output) lines.push(`assistant: ${r.output}`);
  const txt = lines.join('\n\n');
  try { await navigator.clipboard.writeText(txt); copyTranscript.textContent='Copied'; setTimeout(()=>copyTranscript.textContent='Copy transcript',1000);}catch{}
};

function escapeHtml(s='') {
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* Boot */
refreshProviders(); refreshModels(); refreshUsage();
</script>
</body>
</html>