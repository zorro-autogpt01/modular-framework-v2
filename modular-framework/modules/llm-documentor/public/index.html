
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM Documentation Generator</title>
  <style>
    :root {
      --bg: #0f0f10; --panel: #17181a; --line: #2a2c31; --txt: #e6e6e6; --muted: #a0a0a0;
      --accent: #0e639c; --success: #4ec9b0; --warning: #f48771; --error: #d16969;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: var(--bg); color: var(--txt); line-height: 1.6; }
    .header { background: var(--panel); border-bottom: 1px solid var(--line); padding: 16px 24px; display: flex; align-items: center; gap: 16px; }
    .header h1 { font-size: 20px; font-weight: 500; }
    .status-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--success); margin-left: auto; }
    .container { max-width: 1300px; margin: 0 auto; padding: 24px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
    .card { background: var(--panel); border: 1px solid var(--line); border-radius: 8px; padding: 20px; }
    .card h2 { font-size: 16px; margin-bottom: 16px; color: var(--txt); }
    .form-group { margin-bottom: 12px; }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: .5px; }
    input, select, textarea { width: 100%; padding: 10px 12px; background: #111; border: 1px solid var(--line); border-radius: 6px; color: var(--txt); font-size: 14px; font-family: inherit; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); background: #161616; }
    .checkbox-row { display: flex; align-items: center; gap: 8px; margin: 8px 0; }
    .btn { padding: 10px 16px; background: var(--accent); color: #fff; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; }
    .btn.ghost { background: #2a2c31; color: #fff; }
    .btn.secondary { background: var(--line); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .jobs-list { margin-top: 24px; }
    .job-item { background: #111; border: 1px solid var(--line); border-radius: 6px; padding: 16px; margin-bottom: 12px; display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: center; }
    .job-info h3 { font-size: 14px; color: var(--txt); margin-bottom: 4px; }
    .job-info .meta { display: flex; gap: 12px; font-size: 12px; color: var(--muted); flex-wrap: wrap; }
    .job-status { display: flex; align-items: center; gap: 8px; }
    .status-badge { padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 500; }
    .status-badge.pending { background: var(--warning); color: #111; }
    .status-badge.extracting, .status-badge.generating, .status-badge.verifying { background: var(--accent); color: #fff; }
    .status-badge.complete { background: var(--success); color: #111; }
    .status-badge.failed { background: var(--error); color: #fff; }
    .progress-bar { height: 4px; background: var(--line); border-radius: 2px; overflow: hidden; margin-top: 8px; }
    .progress-fill { height: 100%; background: var(--accent); transition: width .3s; }
    .message { padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; display: none; }
    .message.show { display: block; }
    .message.info { background: var(--accent); }
    .message.success { background: var(--success); color: #111; }
    .message.error { background: var(--error); }
    .loading { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--line); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .two-grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .modal { position: fixed; inset: 0; display: none; background: rgba(0,0,0,.45); z-index: 1000; }
    .modal .box { background: var(--panel); border: 1px solid var(--line); border-radius: 8px; margin: 5vh auto; max-width: 1000px; width: 92%; max-height: 90vh; overflow: auto; padding: 16px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .file-list { border:1px solid var(--line); border-radius:6px; padding:8px; background:#111; max-height: 50vh; overflow:auto; }
    .file-list a { color:#cfd; text-decoration:none; display:block; padding:4px 6px; border-radius:4px; }
    .file-list a:hover { background:#1a1a1a; }
    .preview { border:1px solid var(--line); border-radius:6px; padding:8px; background:#111; min-height: 40vh; overflow:auto; white-space: pre-wrap; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } .two-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="header">
    <h1>ðŸ“š LLM Documentation Generator</h1>
    <span style="color: var(--muted); font-size: 14px;">Automated code documentation using AI</span>
    <div class="status-indicator" id="statusIndicator"></div>
  </div>

  <div class="container">
    <div id="message" class="message"></div>

    <div class="grid">
      <div class="card">
        <h2>Repository & Model</h2>
        <div class="checkbox-row">
          <input type="checkbox" id="useGhHub" checked>
          <label for="useGhHub" style="margin:0; text-transform:none; letter-spacing: normal;">Use GitHub Hub configured repository</label>
        </div>
        <div class="form-group">
          <label for="repoUrl">Repository URL</label>
          <input type="text" id="repoUrl" placeholder="https://github.com/owner/repo" disabled>
        </div>
        <div class="two-grid">
          <div class="form-group">
            <label for="branch">Branch</label>
            <input type="text" id="branch" value="main" placeholder="main">
          </div>
          <div class="form-group">
            <label for="modelKey">LLM Model (from LLM Gateway)</label>
            <select id="modelKey"><option value="">Loading modelsâ€¦</option></select>
          </div>
        </div>
        <div class="two-grid">
          <div class="form-group">
            <label>Temperature</label>
            <input type="number" id="temperature" step="0.1" min="0" max="2" value="0.3">
          </div>
          <div class="form-group">
            <label>Max tokens</label>
            <input type="number" id="maxTokens" value="4000">
          </div>
        </div>
        <div class="two-grid">
          <div class="form-group">
            <label>Prompt size limit</label>
            <input type="number" id="promptLimit" value="8000">
          </div>
          <div class="form-group">
            <label>Reasoning</label>
            <select id="reasoning">
              <option value="false">false</option>
              <option value="true">true</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="forceRefresh"> Force refresh (ignore cache)</label>
          <label><input type="checkbox" id="incremental"> Incremental mode (changed components only)</label>
        </div>
      </div>

      <div class="card">
        <h2>Scope & Packs</h2>
        <div class="form-group">
          <label>Include globs (comma)</label>
          <input id="includeGlobs" placeholder="modules/**, src/**">
        </div>
        <div class="form-group">
          <label>Exclude globs (comma)</label>
          <input id="excludeGlobs" placeholder="**/node_modules/**, **/*.min.js">
        </div>
        <div class="two-grid">
          <div class="form-group">
            <label>Modules (by folder name, comma)</label>
            <input id="modules" placeholder="llm-chat, llm-gateway">
          </div>
          <div class="form-group">
            <label>File types (extensions, comma)</label>
            <input id="fileTypes" placeholder="py, js, ts, sql">
          </div>
        </div>

        <div class="checkbox-group" id="packsContainer" style="display:grid; grid-template-columns: repeat(2,1fr); gap:12px;">
          <div class="checkbox-item" style="display:flex; gap:8px; align-items:center; padding:8px; background:#111; border:1px solid var(--line); border-radius:6px;">
            <input type="checkbox" id="pack-high-level" value="high-level" checked>
            <div><label for="pack-high-level" style="margin:0; text-transform:none; letter-spacing:normal;">High-Level Overview</label>
            <small style="display:block; color:var(--muted);">Architecture and system design</small></div>
          </div>
          <div class="checkbox-item" style="display:flex; gap:8px; align-items:center; padding:8px; background:#111; border:1px solid var(--line); border-radius:6px;">
            <input type="checkbox" id="pack-api" value="api" checked>
            <div><label for="pack-api" style="margin:0; text-transform:none; letter-spacing:normal;">API Reference</label>
            <small style="display:block; color:var(--muted);">Endpoint documentation</small></div>
          </div>
          <div class="checkbox-item" style="display:flex; gap:8px; align-items:center; padding:8px; background:#111; border:1px solid var(--line); border-radius:6px;">
            <input type="checkbox" id="pack-components" value="detailed" checked>
            <div><label for="pack-components" style="margin:0; text-transform:none; letter-spacing:normal;">Components</label>
            <small style="display:block; color:var(--muted);">Module documentation</small></div>
          </div>
          <div class="checkbox-item" style="display:flex; gap:8px; align-items:center; padding:8px; background:#111; border:1px solid var(--line); border-radius:6px;">
            <input type="checkbox" id="pack-db" value="db">
            <div><label for="pack-db" style="margin:0; text-transform:none; letter-spacing:normal;">Database Schema</label>
            <small style="display:block; color:var(--muted);">Tables and relationships</small></div>
          </div>
          <div class="checkbox-item" style="display:flex; gap:8px; align-items:center; padding:8px; background:#111; border:1px solid var(--line); border-radius:6px;">
            <input type="checkbox" id="pack-ops" value="ops">
            <div><label for="pack-ops" style="margin:0; text-transform:none; letter-spacing:normal;">Operations</label>
            <small style="display:block; color:var(--muted);">Deployment and DevOps</small></div>
          </div>
          <div class="checkbox-item" style="display:flex; gap:8px; align-items:center; padding:8px; background:#111; border:1px solid var(--line); border-radius:6px;">
            <input type="checkbox" id="pack-cookbook" value="cookbook">
            <div><label for="pack-cookbook" style="margin:0; text-transform:none; letter-spacing:normal;">Cookbook</label>
            <small style="display:block; color:var(--muted);">How-to guides</small></div>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn" id="generateBtn">Generate Documentation</button>
          <button class="btn secondary" id="refreshBtn">Refresh Jobs</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Templates (Optional)</h2>
        <div class="two-grid">
          <div class="form-group">
            <label>Template name</label>
            <select id="tplName"></select>
          </div>
          <div class="form-group">
            <label>Pack preset (extra prompt)</label>
            <select id="tplPack">
              <option value="">(none)</option>
              <option value="high-level">high-level</option>
              <option value="api">api</option>
              <option value="detailed">detailed</option>
              <option value="super-detailed">super-detailed</option>
              <option value="db">db</option>
              <option value="ops">ops</option>
              <option value="cookbook">cookbook</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Template content</label>
          <textarea id="tplContent" rows="8" placeholder="Edit templateâ€¦"></textarea>
        </div>
        <div class="form-group">
          <label>Extra instructions for selected pack (appended to prompt)</label>
          <textarea id="tplPackPrompt" rows="4" placeholder="e.g. Use terse style for API errors"></textarea>
        </div>
        <div class="row">
          <button class="btn" id="tplSaveBtn">Save Template</button>
          <button class="btn ghost" id="tplReloadBtn">Reload List</button>
        </div>
      </div>

      <div class="card">
        <h2>Schedules & Webhooks</h2>
        <div class="form-group">
          <label>Every (seconds)</label>
          <input id="schedEvery" type="number" value="0">
        </div>
        <div class="form-group">
          <label>Schedule packs (comma)</label>
          <input id="schedPacks" placeholder="high-level, detailed">
        </div>
        <div class="row">
          <button class="btn" id="schedAddBtn">Add/Replace Schedule</button>
          <button class="btn ghost" id="schedLoadBtn">Load Schedules</button>
        </div>
        <div class="form-group">
          <label>Current schedules</label>
          <pre id="schedView" class="preview" style="min-height:120px;"></pre>
        </div>
        <div class="form-group">
          <label>GitHub Webhook</label>
          <div class="muted">POST /api/webhook/github with push event; triggers auto-generation on main</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Generation Jobs</h2>
      <div class="jobs-list" id="jobsList">
        <p style="color: var(--muted); text-align: center; padding: 20px;">
          No jobs yet. Generate documentation to get started.
        </p>
      </div>
      <div class="row">
        <div class="two-grid" style="width:100%;">
          <div>
            <label>Compare job A</label>
            <input id="diffA" placeholder="job id">
          </div>
          <div>
            <label>Compare job B</label>
            <input id="diffB" placeholder="job id">
          </div>
        </div>
        <button class="btn ghost" id="diffBtn">Compare</button>
      </div>
      <div class="form-group">
        <label>Diff result</label>
        <pre id="diffView" class="preview"></pre>
      </div>
    </div>
  </div>

  <!-- Preview modal -->
  <div class="modal" id="previewModal">
    <div class="box">
      <div class="row" style="justify-content: space-between;">
        <h3>Job Preview</h3>
        <button class="btn ghost" onclick="closePreview()">Close</button>
      </div>
      <div class="two-grid" style="margin-top:10px;">
        <div>
          <div id="fileList" class="file-list"></div>
        </div>
        <div>
          <div class="row">
            <button class="btn ghost" id="copyBtn">Copy</button>
            <button class="btn ghost" id="openChatBtn">Open in LLM Chat</button>
          </div>
          <pre id="filePreview" class="preview"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin + '/api';
    const message = document.getElementById('message');
    const generateBtn = document.getElementById('generateBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const jobsList = document.getElementById('jobsList');
    const statusIndicator = document.getElementById('statusIndicator');
    const useGhHub = document.getElementById('useGhHub');
    const repoUrlEl = document.getElementById('repoUrl');
    const branchEl = document.getElementById('branch');
    const modelSel = document.getElementById('modelKey');
    const tempEl = document.getElementById('temperature');
    const maxTokEl = document.getElementById('maxTokens');
    const promptLimitEl = document.getElementById('promptLimit');
    const reasoningEl = document.getElementById('reasoning');
    const incEl = document.getElementById('incremental');

    const tplName = document.getElementById('tplName');
    const tplContent = document.getElementById('tplContent');
    const tplPack = document.getElementById('tplPack');
    const tplPackPrompt = document.getElementById('tplPackPrompt');

    const schedEvery = document.getElementById('schedEvery');
    const schedPacks = document.getElementById('schedPacks');
    const schedView = document.getElementById('schedView');

    let jobs = [];
    let activeJobId = null;
    let previewJobId = null;
    let currentFile = '';

    function showMessage(text, type = 'info') {
      message.textContent = text;
      message.className = `message show ${type}`;
      setTimeout(() => message.classList.remove('show'), 4000);
    }
    function toggleRepoInputs() { repoUrlEl.disabled = useGhHub.checked; }
    useGhHub.addEventListener('change', toggleRepoInputs);

    function getSelectedPacks() {
      const ids = ['pack-high-level','pack-api','pack-components','pack-db','pack-ops','pack-cookbook'];
      return ids.map(id => document.getElementById(id)).filter(cb => cb && cb.checked).map(cb => cb.value);
    }

    function modelOptionLabel(m) {
      const name = m.display_name || m.model_name || '(model)';
      const prov = m.provider_kind ? ` Â· ${m.provider_kind}` : '';
      return `${name}${prov}${m.key ? '' : ' (no key)'}`;
    }

    async function loadDefaultRepo() {
      try {
        const res = await fetch(`${API_BASE}/default-repo`);
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        if (data.repo_url) repoUrlEl.value = data.repo_url;
        if (data.default_branch) branchEl.value = data.default_branch;
      } catch (e) { console.warn('default repo load failed', e); }
    }

    async function loadModels() {
      try {
        modelSel.innerHTML = `<option value="">Loadingâ€¦</option>`;
        const res = await fetch(`${API_BASE}/models`);
        const data = await res.json();
        const items = data.items || [];
        modelSel.innerHTML = '';
        for (const m of items) {
          const opt = document.createElement('option');
          opt.value = m.key || '';
          opt.textContent = modelOptionLabel(m);
          opt.dataset.id = m.id != null ? String(m.id) : '';
          opt.dataset.name = m.model_name || '';
          opt.dataset.key = m.key || '';
          modelSel.appendChild(opt);
        }
        if (modelSel.options.length > 0) modelSel.selectedIndex = 0;
      } catch (e) {
        modelSel.innerHTML = `<option value="">Failed to load models</option>`;
      }
    }

    async function apiGenerate(payload) {
      const res = await fetch(`${API_BASE}/generate`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function generateDocs() {
      const packs = getSelectedPacks();
      if (packs.length === 0) return showMessage('Select at least one pack', 'error');

      const branch = branchEl.value.trim() || 'main';
      const selOpt = modelSel.options[modelSel.selectedIndex];
      if (!selOpt) return showMessage('Select a model', 'error');

      const includeGlobs = document.getElementById('includeGlobs').value.trim();
      const excludeGlobs = document.getElementById('excludeGlobs').value.trim();
      const modules = document.getElementById('modules').value.trim();
      const fileTypes = document.getElementById('fileTypes').value.trim();

      const payload = {
        packs,
        branch,
        force_refresh: document.getElementById('forceRefresh').checked,
        incremental: incEl.checked,
        include_globs: includeGlobs ? includeGlobs.split(',').map(s=>s.trim()).filter(Boolean) : [],
        exclude_globs: excludeGlobs ? excludeGlobs.split(',').map(s=>s.trim()).filter(Boolean) : [],
        modules: modules ? modules.split(',').map(s=>s.trim()).filter(Boolean) : [],
        file_types: fileTypes ? fileTypes.split(',').map(s=>s.trim()).filter(Boolean) : [],
        temperature: Number(tempEl.value || 0.3),
        max_tokens: Number(maxTokEl.value || 4000),
        prompt_limit: Number(promptLimitEl.value || 8000),
        reasoning: (reasoningEl.value === 'true')
      };

      if (!useGhHub.checked) {
        const repoUrl = repoUrlEl.value.trim();
        if (!repoUrl) return showMessage('Repository URL is required when not using GitHub Hub repo', 'error');
        payload.repo_url = repoUrl;
      }

      const model_key = selOpt.dataset.key || '';
      const model_id = selOpt.dataset.id ? Number(selOpt.dataset.id) : null;
      const model_name = selOpt.dataset.name || '';
      if (model_key) payload.model_key = model_key;
      else if (model_id) payload.model_id = model_id;
      else if (model_name) payload.model_name = model_name;

      // Pack prompt from UI template section (optional)
      if (tplPack.value && tplPackPrompt.value.trim()) {
        payload.pack_prompts = { [tplPack.value]: tplPackPrompt.value.trim() };
      }
      // If editing a template name; include override mapping
      if (tplName.value) {
        payload.per_pack_templates = { [tplPack.value || packs[0]]: tplName.value };
      }

      generateBtn.disabled = true; generateBtn.innerHTML = '<span class="loading"></span> Starting...';
      try {
        const result = await apiGenerate(payload);
        activeJobId = result.job_id;
        showMessage('Generation started', 'success');
        pollJobStatus(activeJobId);
      } catch (e) {
        showMessage(`Start failed: ${e.message}`, 'error');
      } finally {
        generateBtn.disabled = false; generateBtn.textContent = 'Generate Documentation';
      }
    }

    async function pollJobStatus(jobId) {
      const t = setInterval(async () => {
        try {
          const r = await fetch(`${API_BASE}/jobs/${jobId}`);
          const job = await r.json();
          updateJobInList(job);
          if (job.status === 'complete' || job.status === 'failed') {
            clearInterval(t);
            showMessage(job.status === 'complete' ? 'Documentation generated' : `Failed: ${job.error}`, job.status === 'complete' ? 'success' : 'error');
          }
        } catch (e) {
          clearInterval(t);
          showMessage(`Polling error: ${e.message}`, 'error');
        }
      }, 2000);
    }

    function renderJobs() {
      if (jobs.length === 0) {
        jobsList.innerHTML = `<p style="color: var(--muted); text-align: center; padding: 20px;">No jobs yet. Generate documentation to get started.</p>`;
        return;
      }
      jobsList.innerHTML = jobs.map(job => `
        <div class="job-item">
          <div class="job-info">
            <h3>${(job.repo_url || 'github-hub repo').split('/').pop()} @ ${job.branch}</h3>
            <div class="meta">
              <span>ID: ${job.id.substring(0, 8)}</span>
              <span>${new Date(job.started_at).toLocaleString()}</span>
              <span>${job.packs.join(', ')}</span>
            </div>
            ${job.status !== 'complete' && job.status !== 'failed' ? `
              <div class="progress-bar"><div class="progress-fill" style="width: ${job.progress}%"></div></div>
              <div style="color: var(--muted); font-size: 12px; margin-top: 4px;">${job.message}</div>
            ` : ''}
          </div>
          <div class="job-status">
            <span class="status-badge ${job.status}">${job.status}</span>
            <button class="btn ghost" onclick="previewJob('${job.id}')">Preview</button>
            ${job.status === 'complete' ? `<button class="btn secondary" onclick="downloadDocs('${job.id}')">Download</button>
            <button class="btn" onclick="publishJob('${job.id}')">Publish</button>` : ''}
          </div>
        </div>
      `).join('');
    }

    function updateJobInList(job) {
      const i = jobs.findIndex(j => j.id === job.id);
      if (i >= 0) jobs[i] = job; else jobs.unshift(job);
      renderJobs();
    }

    async function loadJobs() {
      try {
        const response = await fetch(`${API_BASE}/jobs`);
        const data = await response.json();
        jobs = data.jobs || [];
        renderJobs();
        const healthResponse = await fetch(`${API_BASE}/health`);
        statusIndicator.style.background = healthResponse.ok ? 'var(--success)' : 'var(--error)';
      } catch (error) {
        showMessage(`Failed to load jobs: ${error.message}`, 'error');
        statusIndicator.style.background = 'var(--error)';
      }
    }

    async function downloadDocs(jobId) { window.open(`${API_BASE}/output/${jobId}`, '_blank'); }

    // Preview modal
    async function previewJob(jobId) {
      previewJobId = jobId; currentFile = '';
      const list = document.getElementById('fileList');
      const preview = document.getElementById('filePreview');
      preview.textContent = '';
      list.innerHTML = 'Loadingâ€¦';
      document.getElementById('previewModal').style.display = 'block';
      try {
        const r = await fetch(`${API_BASE}/output/${jobId}/files`);
        const data = await r.json();
        list.innerHTML = '';
        (data.files || []).forEach(p => {
          const a = document.createElement('a');
          a.href = '#'; a.textContent = p; a.onclick = async (e) => {
            e.preventDefault(); currentFile = p; await loadFilePreview(jobId, p);
          };
          list.appendChild(a);
        });
      } catch (e) {
        list.innerHTML = 'Failed to load file list.';
      }
    }
    async function loadFilePreview(jobId, path) {
      try {
        const r = await fetch(`${API_BASE}/output/${jobId}/file?path=${encodeURIComponent(path)}`);
        const data = await r.json();
        document.getElementById('filePreview').textContent = data.content || '';
      } catch { document.getElementById('filePreview').textContent = 'Failed to load file.'; }
    }
    function closePreview(){ document.getElementById('previewModal').style.display='none'; }

    async function copyCurrent() {
      const text = document.getElementById('filePreview').textContent || '';
      try { await navigator.clipboard.writeText(text); showMessage('Copied to clipboard', 'success'); }
      catch { showMessage('Copy failed', 'error'); }
    }
    async function openInChat() {
      await copyCurrent();
      window.open('/modules/llm-chat/', '_blank');
    }

    async function publishJob(jobId) {
      const prefix = prompt('Publish under path prefix (default: docs/generated)', 'docs/generated');
      if (prefix === null) return;
      const body = { path_prefix: prefix || 'docs/generated' };
      try {
        const res = await fetch(`${API_BASE}/publish/${jobId}`, {
          method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || JSON.stringify(data));
        const url = data?.pull_request?.html_url || '(no url)';
        showMessage(`Published! PR: ${url}`, 'success');
        window.open(url, '_blank');
      } catch (e) {
        showMessage(`Publish failed: ${e.message}`, 'error');
      }
    }

    // Diff
    async function diffJobs() {
      const a = document.getElementById('diffA').value.trim();
      const b = document.getElementById('diffB').value.trim();
      if (!a || !b) return showMessage('Enter job ids A and B', 'error');
      try {
        const r = await fetch(`${API_BASE}/jobs/diff?a=${encodeURIComponent(a)}&b=${encodeURIComponent(b)}`);
        const data = await r.json();
        const diffs = data.diffs || {};
        const lines = [];
        for (const k of Object.keys(diffs)) {
          lines.push(`=== ${k} ===`); lines.push(diffs[k] || ''); lines.push('');
        }
        document.getElementById('diffView').textContent = lines.join('\n');
      } catch (e) {
        showMessage(`Diff failed: ${e.message}`, 'error');
      }
    }

    // Templates
    async function loadTemplates() {
      try {
        tplName.innerHTML = '';
        const r = await fetch(`${API_BASE}/templates`);
        const data = await r.json();
        (data.items || []).forEach(n => {
          const o = document.createElement('option'); o.value = n; o.textContent = n; tplName.appendChild(o);
        });
        tplName.onchange = async () => {
          if (!tplName.value) { tplContent.value=''; return; }
          const r2 = await fetch(`${API_BASE}/templates/${encodeURIComponent(tplName.value)}`);
          const d2 = await r2.json(); tplContent.value = d2.content || '';
        };
        if (tplName.options.length > 0) {
          tplName.selectedIndex = 0; tplName.onchange();
        }
      } catch {}
    }
    async function saveTemplate() {
      if (!tplName.value) return showMessage('Choose a template name (type a new one if needed)', 'error');
      try {
        const res = await fetch(`${API_BASE}/templates/${encodeURIComponent(tplName.value)}`, {
          method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ content: tplContent.value || '' })
        });
        if (!res.ok) throw new Error(await res.text());
        showMessage('Template saved', 'success');
        loadTemplates();
      } catch (e) { showMessage(`Save failed: ${e.message}`, 'error'); }
    }

    // Schedules
    async function loadSchedules() {
      try { const r = await fetch(`${API_BASE}/schedules`); const d = await r.json(); schedView.textContent = JSON.stringify(d.items || [], null, 2); }
      catch { schedView.textContent = 'Failed to load'; }
    }
    async function addSchedule() {
      const every = Number(schedEvery.value || 0);
      const packs = (schedPacks.value || '').split(',').map(s=>s.trim()).filter(Boolean);
      const items = every > 0 ? [{ id: 'default', every_seconds: every, packs, use_hub: true, branch: branchEl.value || 'main' }] : [];
      try {
        const r = await fetch(`${API_BASE}/schedules`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ items }) });
        if (!r.ok) throw new Error(await r.text());
        showMessage('Schedules updated', 'success');
        loadSchedules();
      } catch (e) { showMessage(`Update failed: ${e.message}`, 'error'); }
    }

    // Wire UI
    document.getElementById('copyBtn').addEventListener('click', copyCurrent);
    document.getElementById('openChatBtn').addEventListener('click', openInChat);
    document.getElementById('diffBtn').addEventListener('click', diffJobs);
    document.getElementById('tplSaveBtn').addEventListener('click', saveTemplate);
    document.getElementById('tplReloadBtn').addEventListener('click', loadTemplates);
    document.getElementById('schedLoadBtn').addEventListener('click', loadSchedules);
    document.getElementById('schedAddBtn').addEventListener('click', addSchedule);

    generateBtn.addEventListener('click', generateDocs);
    refreshBtn.addEventListener('click', loadJobs);

    async function init() {
      toggleRepoInputs();
      await Promise.all([loadDefaultRepo(), loadModels(), loadJobs(), loadTemplates(), loadSchedules()]);
      setInterval(loadJobs, 10000);
    }
    init();

    window.previewJob = previewJob;
    window.closePreview = closePreview;
    window.downloadDocs = downloadDocs;
    window.publishJob = publishJob;
  </script>
</body>
</html>
