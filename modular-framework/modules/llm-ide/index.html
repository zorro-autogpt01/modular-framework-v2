<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="github-hub-base" content="/api/github-hub">
  <title>Advanced Web IDE Pro - GitHub Enhanced</title>
  <link rel="stylesheet" href="assets/css/base.css" />
  <link rel="stylesheet" href="assets/css/ide.css" />
  <style>
    /* GitHub integration styles */
    .github-mode-toggle {
      display: flex;
      gap: 4px;
      margin: 8px 0;
      background: #2d2d30;
      border-radius: 4px;
      padding: 2px;
    }
    .github-mode-toggle button {
      flex: 1;
      padding: 4px 8px;
      background: transparent;
      border: none;
      color: #9d9d9d;
      cursor: pointer;
      border-radius: 2px;
      font-size: 11px;
    }
    .github-mode-toggle button.active {
      background: #094771;
      color: #fff;
    }
    .git-commands-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
      margin: 8px 0;
    }
    .staged-files {
      background: #1e1e1e;
      border: 1px solid #3e3e3e;
      border-radius: 4px;
      padding: 8px;
      margin: 8px 0;
      max-height: 150px;
      overflow-y: auto;
    }
    .staged-file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px;
      font-size: 11px;
    }
    .staged-file-item:hover {
      background: #2a2d2e;
    }
    .github-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-left: 4px;
    }
    .github-indicator.synced { background: #27ae60; }
    .github-indicator.modified { background: #ff9800; }
    .github-indicator.untracked { background: #9d9d9d; }

    /* --- Triple editor layout --- */
    .editor-container.triple {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr;
      gap: 6px;
      height: 100%;
    }
    .editor-pane {
      display: flex;
      flex-direction: column;
      min-height: 0;
      border-left: 1px solid #3e3e3e;
      border-right: 1px solid #3e3e3e;
      background: #1e1e1e;
    }
    .editor-pane .editor-header {
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 8px;
      background: #2d2d30;
      border-bottom: 1px solid #3e3e3e;
      font-size: 12px;
    }
    .editor-pane .editor-body {
      flex: 1;
      min-height: 0;
      position: relative;
      display: flex;
    }
    .editor-pane .editor-body > div {
      flex: 1;
      min-width: 0;
      min-height: 0;
    }
    .editor-pane.focused .editor-header { background: #094771; color: #fff; }
    .editor-left { grid-column: 1; grid-row: 1; }
    .editor-right-top {
      grid-column: 2;
      grid-row: 1;
      display: grid;
      grid-template-rows: 1fr 1fr;
    }
    .editor-right-top .pane-top,
    .editor-right-top .pane-bottom {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    /* Monaco hosts */
    #monaco-editor-1, #monaco-editor-2, #monaco-editor-3, #monaco-diff {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div class="ide-container">
    <!-- Repository Sidebar -->
    <aside class="repo-sidebar">
      <div class="sidebar-header">
        <span>REPOSITORY</span>
        <button class="btn small" data-action="modal:open" data-target="#githubModal" aria-label="Open GitHub modal">üîó</button>
      </div>
      <div class="sidebar-content">
        <div class="repo-explorer">
          <!-- Git Section -->
          <section class="repo-section">
            <header class="repo-section-header" data-toggle-section="git">
              <span>üåø Git Repository</span>
              <span id="gitToggle">‚ñº</span>
            </header>
            <div class="repo-section-content" id="gitSection">
              <div class="github-mode-toggle">
                <button id="modeLocal" class="active" onclick="switchGitMode('local')">Local Git</button>
                <button id="modeGithub" onclick="switchGitMode('github')">GitHub API</button>
              </div>

              <div class="input-group">
                <label for="branchSelector">Current Branch</label>
                <select id="branchSelector">
                  <option value="main">main</option>
                  <option value="develop">develop</option>
                  <option value="feature/auth">feature/auth</option>
                </select>
              </div>

              <div class="git-commands-grid">
                <button class="btn small" data-action="git:add" title="Stage all changes">Add</button>
                <button class="btn small" data-action="git:commit" title="Commit staged changes">Commit</button>
                <button class="btn small" data-action="git:push" title="Push to remote">Push</button>
                <button class="btn small" data-action="git:pull" title="Pull from remote">Pull</button>
                <button class="btn small" data-action="git:fetch" title="Fetch updates">Fetch</button>
                <button class="btn small secondary" data-action="git:stash" title="Stash changes">Stash</button>
                <button class="btn small secondary" data-action="git:reset" title="Reset changes">Reset</button>
                <button class="btn small secondary" data-action="git:checkout" title="Switch branch">Switch</button>
                <button class="btn small secondary" data-action="git:merge" title="Merge branch">Merge</button>
                <button class="btn small secondary" data-action="git:rebase" title="Rebase branch">Rebase</button>
                <button class="btn small danger" data-action="git:reset-hard" title="Hard reset">Hard Reset</button>
                <button class="btn small" data-action="git:status" title="Check status">Status</button>
              </div>

              <div class="staged-files" id="stagedFiles">
                <div class="sub-title">STAGED FILES</div>
                <div id="stagedFilesList"></div>
              </div>

              <div class="input-group">
                <label for="commitMessage">Commit Message</label>
                <textarea class="db-query-editor" id="commitMessage" placeholder="Commit message..."></textarea>
              </div>

              <div id="githubHubActions" style="display:none;">
                <div class="sub-title">GITHUB DIRECT ACTIONS</div>
                <div class="grid-2">
                  <button class="btn small" data-action="github:open-hub-ui">Open Hub UI</button>
                  <button class="btn small" data-action="github:sync">Sync Files</button>
                  <button class="btn small success" data-action="github:batch-commit">Batch Commit</button>
                  <button class="btn small secondary" data-action="github:create-pr">Create PR</button>
                </div>
              </div>

              <button class="btn success small" data-action="git:quick-commit-push">üí´ Commit & Push</button>

              <div class="repo-sublist">
                <div class="sub-title">BRANCHES</div>
                <div class="branch-list" id="branchList">
                  <div class="branch-item current"><span>üåø main</span><span>*</span></div>
                  <div class="branch-item"><span>üåø develop</span><span></span></div>
                  <div class="branch-item"><span>üåø feature/auth</span><span></span></div>
                </div>
              </div>

              <div class="repo-sublist">
                <div class="sub-title">RECENT COMMITS</div>
                <div class="commit-list" id="commitList">
                  <div class="commit-item">
                    <div><span class="commit-hash">a1b2c3d</span> Initial commit</div>
                    <div class="muted">today - System</div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Docker Section -->
          <section class="repo-section">
            <header class="repo-section-header" data-toggle-section="docker">
              <span>üê≥ Docker</span>
              <span id="dockerToggle">‚ñº</span>
            </header>
            <div class="repo-section-content" id="dockerSection">
              <div class="grid-2">
                <button class="btn small" data-action="docker:build">Build</button>
                <button class="btn small success" data-action="docker:run">Run</button>
                <button class="btn small secondary" data-action="docker:ps">List</button>
                <button class="btn small danger" data-action="docker:stop">Stop All</button>
              </div>
              <div class="repo-sublist">
                <div class="sub-title">CONTAINERS</div>
                <div id="dockerContainers">
                  <div class="docker-container">
                    <div class="row">
                      <div class="container-status running"></div>
                      <span>frontend</span>
                    </div>
                    <span class="ok">Running</span>
                  </div>
                  <div class="docker-container">
                    <div class="row">
                      <div class="container-status running"></div>
                      <span>backend</span>
                    </div>
                    <span class="ok">Running</span>
                  </div>
                  <div class="docker-container">
                    <div class="row">
                      <div class="container-status stopped"></div>
                      <span>postgres</span>
                    </div>
                    <span class="err">Stopped</span>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Database + SSH Section -->
          <section class="repo-section">
            <header class="repo-section-header" data-toggle-section="database">
              <span>üóÑÔ∏è Database</span>
              <span id="databaseToggle">‚ñº</span>
            </header>
            <div class="repo-section-content" id="databaseSection">
              <button class="btn small" data-action="database:open-add-modal">‚ûï Add Connection</button>
              <div class="repo-sublist">
                <div class="sub-title">CONNECTIONS</div>
                <div id="databaseConnections">
                  <div class="database-connection" data-action="database:connect" data-connection="postgres_dev">
                    <div class="row"><div class="db-status connected"></div><span>PostgreSQL Dev</span></div>
                    <span class="ok">‚óè</span>
                  </div>
                  <div class="database-connection" data-action="database:connect" data-connection="mysql_prod">
                    <div class="row"><div class="db-status disconnected"></div><span>MySQL Prod</span></div>
                    <span class="err">‚óè</span>
                  </div>
                </div>
              </div>

              <hr style="border:0;border-top:1px solid #3e3e3e;margin:8px 0;" />
              <div class="repo-sublist">
                <div class="sub-title">SSH CONNECTION</div>
                <div class="connection-panel" style="padding:8px;background:#1e1e1e;border-radius:4px;">
                  <div class="connection-status">
                    <div class="status-indicator" id="connectionStatus"></div>
                    <span id="connectionText">Disconnected</span>
                  </div>
                  <div class="grid-2">
                    <div class="input-group">
                      <label for="sshHost">Host</label>
                      <input type="text" id="sshHost" placeholder="dev-server.local" />
                    </div>
                    <div class="input-group">
                      <label for="sshPort">Port</label>
                      <input type="number" id="sshPort" value="22" />
                    </div>
                  </div>
                  <div class="grid-2">
                    <div class="input-group">
                      <label for="sshUsername">Username</label>
                      <input type="text" id="sshUsername" placeholder="developer" />
                    </div>
                    <div class="input-group">
                      <label for="authMethod">Authentication</label>
                      <select id="authMethod">
                        <option value="key">SSH Key</option>
                        <option value="password">Password</option>
                      </select>
                    </div>
                  </div>
                  <div class="input-group hidden" id="passwordGroup">
                    <label for="sshPassword">Password</label>
                    <input type="password" id="sshPassword" />
                    <div class="muted">Your password is used once to establish the SSH session via the local bridge and is not persisted or logged.</div>
                  </div>
                  <div class="input-group" id="privateKeyGroup">
                    <label for="sshPrivateKey">Private Key (PEM)</label>
                    <textarea id="sshPrivateKey" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----"></textarea>
                    <div class="muted">Your key is kept in-memory in this browser tab and only sent to the local SSH bridge to start the session. It is not stored or logged.</div>
                    <div class="row gap-8 top-16">
                      <input type="file" id="sshKeyFile" accept=".pem,.key,.txt" />
                      <button class="btn small secondary" id="sshKeyFileLoadBtn" type="button">Load Key File</button>
                    </div>
                  </div>
                  <div class="input-group" id="passphraseGroup">
                    <label for="sshPassphrase">Key Passphrase (optional)</label>
                    <input type="password" id="sshPassphrase" />
                  </div>
                  <div class="input-group">
                    <label for="remotePath">Remote Path</label>
                    <input type="text" id="remotePath" value="/var/www/html" />
                  </div>

                  <div class="row gap-8" style="margin:8px 0; align-items:center;">
                    <label style="display:flex;align-items:center;gap:6px;font-size:11px;">
                      <input type="checkbox" id="sshStoreSecrets" /> Store secrets (password/key) in this browser
                    </label>
                  </div>

                  <div class="grid-2" style="margin-bottom:6px;gap:8px;">
                    <div class="row" style="gap:8px;align-items:center;">
                      <input type="text" class="text-input" id="sshPresetName" placeholder="Preset name (e.g., staging)" />
                    </div>
                    <div class="row" style="gap:8px;align-items:center;">
                      <select id="sshPresetSelect" class="text-input"></select>
                    </div>
                  </div>
                  <div class="grid-2" style="gap:8px;">
                    <div class="row" style="gap:8px;">
                      <button class="btn small secondary" id="sshSavePresetBtn" type="button">üíæ Save Preset</button>
                      <button class="btn small secondary" id="sshLoadPresetBtn" type="button">üì• Load</button>
                    </div>
                    <div class="row" style="gap:8px;justify-content:flex-end;">
                      <button class="btn small danger" id="sshDeletePresetBtn" type="button">üóë Delete Preset</button>
                    </div>
                  </div>

                  <div class="row gap-8 top-16">
                    <button id="connectBtn" class="btn" data-action="ssh:connect">üîó Connect SSH</button>
                    <button id="disconnectBtn" class="btn danger hidden" data-action="ssh:disconnect">Disconnect</button>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </aside>

    <!-- File Explorer Sidebar -->
    <aside class="left-sidebar">
      <div class="sidebar-header">
        <span>FILE EXPLORER</span>
        <div class="row gap-4">
          <button class="btn small secondary" data-action="files:refresh">‚Üª</button>
          <button class="btn small" data-action="files:new-file">üìÑ</button>
        </div>
      </div>
      <div class="sidebar-tabs">
        <div class="sidebar-tab active" data-panel="explorer">üìÅ</div>
        <div class="sidebar-tab" data-panel="search">üîç</div>
      </div>
      <div class="sidebar-content">
        <div id="explorer-panel" class="sidebar-panel">
          <div class="workspace-indicator" id="workspaceIndicator">Local</div>
          <div class="file-tree" id="fileTree">
            <div class="placeholder">Loading files...</div>
          </div>
        </div>
        <div id="search-panel" class="sidebar-panel hidden">
          <div class="pad-12">
            <input id="searchInput" type="text" class="text-input" placeholder="Search in files..." />
            <div id="searchResults" class="scroll max-300"></div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
      <div class="toolbar">
        <div class="toolbar-group">
          <button class="btn small" data-action="editor:save">üíæ</button>
          <button class="btn small secondary" data-action="editor:save-all">üíæ*</button>
          <button class="btn small secondary" data-action="editor:format">üé®</button>
        </div>
        <div class="toolbar-group">
          <button class="btn small secondary" data-action="files:new-file">üìÑ</button>
          <button class="btn small secondary" data-action="files:new-folder">üìÅ</button>
          <button class="btn small secondary" data-action="files:upload">‚¨Ü</button>
        </div>
        <div class="toolbar-group">
          <button class="btn small secondary" data-action="editor:show-diff">üìã</button>
          <button class="btn small secondary" data-action="editor:toggle-minimap">üó∫</button>
          <button class="btn small secondary" data-action="terminal:toggle">üíª</button>
        </div>
        <div class="toolbar-group">
          <button class="btn small" data-action="project:run">‚ñ∂</button>
          <button class="btn small secondary" data-action="project:build">üî®</button>
          <button class="btn small secondary" data-action="project:deploy">üöÄ</button>
        </div>
      </div>
      <div class="content-area">
        <div class="tabs-container" id="tabsContainer"></div>
        <div class="editor-container triple">
          <!-- Left half: full-height editor 1 -->
          <section class="editor-pane editor-left" aria-label="Editor Pane 1">
            <div class="editor-header"><span id="editor1Title">Editor 1</span></div>
            <div class="editor-body">
              <div id="monaco-editor-1" aria-label="Code editor 1"></div>
            </div>
          </section>
          <!-- Right half: two stacked editors (top=editor 2, bottom=editor 3/diff) -->
          <section class="editor-right-top">
            <div class="editor-pane pane-top" aria-label="Editor Pane 2">
              <div class="editor-header"><span id="editor2Title">Editor 2</span></div>
              <div class="editor-body">
                <div id="monaco-editor-2" aria-label="Code editor 2"></div>
              </div>
            </div>
            <div class="editor-pane pane-bottom" aria-label="Editor Pane 3">
              <div class="editor-header"><span id="editor3Title">Editor 3</span></div>
              <div class="editor-body">
                <div id="monaco-editor-3" aria-label="Code editor 3"></div>
                <!-- Diff editor overlays editor 3 when requested by multiEditor.js -->
                <div id="monaco-diff" class="hidden" aria-label="Diff editor"></div>
              </div>
            </div>
          </section>
        </div>
        <div class="bottom-panel" id="bottomPanel">
          <div class="bottom-tabs">
            <div class="bottom-tab active" data-panel="terminal">Terminal</div>
            <div class="bottom-tab" data-panel="problems">Problems (0)</div>
            <div class="bottom-tab" data-panel="output">Output</div>
            <div class="bottom-tab" data-panel="database">Database</div>
            <div class="bottom-tab" data-panel="docker">Docker Logs</div>
          </div>
          <div class="bottom-content">
            <div id="terminal-panel" class="bottom-content-panel">
              <div class="terminal" id="terminal">
                <div>üöÄ Advanced Web IDE Pro - Terminal</div>
                <div>Connected to: <span id="terminalHost">localhost</span></div>
                <div>Type 'help' for available commands</div>
                <div class="terminal-input">
                  <span class="terminal-prompt">$</span>
                  <input type="text" class="terminal-command" id="terminalInput" placeholder="Enter command..." />
                </div>
              </div>
            </div>
            <div id="problems-panel" class="bottom-content-panel hidden">
              <div id="problemsList" class="pad-8 scroll">
                <div class="placeholder">No problems found</div>
              </div>
            </div>
            <div id="output-panel" class="bottom-content-panel hidden">
              <div class="terminal" id="outputContent"><div>Build Output Console</div></div>
            </div>
            <div id="database-panel" class="bottom-content-panel hidden">
              <div class="database-browser">
                <div class="row gap-8">
                  <select id="dbConnectionSelect">
                    <option value="postgres_dev">PostgreSQL Dev</option>
                    <option value="mysql_prod">MySQL Prod</option>
                  </select>
                  <button class="btn small" data-action="database:execute-query">‚ñ∂ Execute</button>
                  <button class="btn small secondary" data-action="database:clear-query">Clear</button>
                </div>
                <textarea class="db-query-editor" id="sqlQuery" placeholder="SELECT * FROM users LIMIT 10;">SELECT * FROM users WHERE created_at > '2024-01-01' ORDER BY id DESC LIMIT 50;</textarea>
                <div class="db-results" id="queryResults">
                  <table class="db-table">
                    <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Created</th></tr></thead>
                    <tbody>
                      <tr><td>1</td><td>John Doe</td><td>john@example.com</td><td>2024-01-15</td></tr>
                      <tr><td>2</td><td>Jane Smith</td><td>jane@example.com</td><td>2024-01-14</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div id="docker-panel" class="bottom-content-panel hidden">
              <div class="terminal" id="dockerLogs">
                <div>üê≥ Docker Container Logs</div>
                <div>[frontend] Starting development server...</div>
                <div>[frontend] Server running on http://localhost:3000</div>
                <div>[backend] API server started on port 3021</div>
                <div>[postgres] Database ready for connections</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="status-bar">
        <div class="status-left">
          <span id="statusMessage">Ready</span>
          <span id="connectionInfo">üîó Local</span>
          <span id="gitInfo">üåø main</span>
          <span id="dockerInfo">üê≥ 3 containers</span>
        </div>
        <div class="status-right">
          <span id="cursorPosition">Line 1, Column 1</span>
          <span id="languageMode">Markdown</span>
          <span id="encodingInfo">UTF-8</span>
        </div>
      </div>
    </main>
  </div>

  <!-- GitHub Modal -->
  <div id="githubModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="githubModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="githubModalTitle">üêô GitHub Integration</h3>
        <span class="modal-close" data-action="modal:close" data-target="#githubModal">√ó</span>
      </div>

      <div class="connection-status" style="margin-bottom: 16px; padding: 12px; background: #1e1e1e; border-radius: 4px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <div id="githubHubStatus" class="status-indicator"></div>
          <span id="githubHubStatusText">Checking GitHub Hub...</span>
        </div>
        <div id="githubHubRepo" style="margin-top: 8px; font-size: 11px; color: #9d9d9d;"></div>
      </div>

      <div id="githubLocalConfig" style="display: none;">
        <div class="input-group">
          <label for="repoUrl">Repository URL (for local git commands)</label>
          <input type="text" id="repoUrl" placeholder="https://github.com/user/repo.git" />
          <div class="muted">Only needed if GitHub Hub is not configured</div>
        </div>
        <div class="input-group">
          <label for="gitAction">Action</label>
          <select id="gitAction">
            <option value="clone">Clone Repository</option>
            <option value="init">Initialize & Connect</option>
            <option value="connect">Connect Existing</option>
          </select>
        </div>
      </div>

      <div id="githubHubConfig" style="display: none;">
        <div class="sub-title">GITHUB HUB ACTIONS</div>
        <div class="grid-2" style="margin-top: 12px;">
          <button class="btn small" data-action="github:open-hub-ui">Open Hub UI</button>
          <button class="btn small" data-action="github:refresh-branches">Refresh Branches</button>
          <button class="btn small secondary" data-action="github:switch-mode">Switch to Local</button>
        </div>
        <div class="muted" style="margin-top: 12px;">
          GitHub Hub is managing repository configuration.
        </div>
      </div>

      <div class="row gap-8 top-16">
        <button id="githubExecuteBtn" class="btn" data-action="github:execute">Execute</button>
        <button class="btn secondary" data-action="modal:close" data-target="#githubModal">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Database Modal -->
  <div id="databaseModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="databaseModalTitle">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="databaseModalTitle">üóÑÔ∏è Add Database Connection</h3>
        <span class="modal-close" data-action="modal:close" data-target="#databaseModal">√ó</span>
      </div>
      <div class="input-group">
        <label for="dbType">Database Type</label>
        <select id="dbType">
          <option value="postgresql">PostgreSQL</option>
          <option value="mysql">MySQL</option>
          <option value="mongodb">MongoDB</option>
          <option value="redis">Redis</option>
          <option value="sqlite">SQLite</option>
        </select>
      </div>
      <div class="input-group"><label for="dbName">Connection Name</label><input type="text" id="dbName" placeholder="My Database" /></div>
      <div class="input-group"><label for="dbHost">Host</label><input type="text" id="dbHost" placeholder="localhost" /></div>
      <div class="input-group"><label for="dbPort">Port</label><input type="number" id="dbPort" placeholder="5432" /></div>
      <div class="input-group"><label for="dbDatabase">Database</label><input type="text" id="dbDatabase" placeholder="myapp" /></div>
      <div class="input-group"><label for="dbUsername">Username</label><input type="text" id="dbUsername" placeholder="user" /></div>
      <div class="input-group"><label for="dbPassword">Password</label><input type="password" id="dbPassword" placeholder="password" /></div>
      <div class="row gap-8 top-16">
        <button class="btn" data-action="database:test-connection">Test Connection</button>
        <button class="btn success" data-action="database:save-connection">Save</button>
        <button class="btn secondary" data-action="modal:close" data-target="#databaseModal">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Monaco Loader (AMD) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
  <script>
    // Configure Monaco path before main.js runs
    if (window.require) {
      window.require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });
    }

    // Endpoints (override window.__BACKEND_URL before this file if needed)
    window.__GITHUB_HUB_URL = window.location.origin + '/api/github-hub';
    window.GITHUB_HUB_BASE = window.__GITHUB_HUB_URL;
    window.__BACKEND_URL = window.__BACKEND_URL || (window.location.origin + '/ide/api');
    // For direct local backend in dev, you can set:
    // window.__BACKEND_URL = window.location.protocol + '//' + window.location.hostname + ':3021';

    // Mode switching function
    function switchGitMode(mode) {
      const btnLocal = document.getElementById('modeLocal');
      const btnGitHub = document.getElementById('modeGithub');
      const ghActions = document.getElementById('githubHubActions');
      if (btnLocal) btnLocal.classList.toggle('active', mode === 'local');
      if (btnGitHub) btnGitHub.classList.toggle('active', mode === 'github');
      if (ghActions) ghActions.style.display = mode === 'github' ? 'block' : 'none';
      // Update workspace indicator text (no GitHub file tree shown here)
      if (mode === 'github') {
        const ind = document.getElementById('workspaceIndicator');
        if (ind) ind.textContent = 'GitHub (Hub UI)';
      }
    }
  </script>

  <!-- Main app -->
  <script type="module" src="src/main.js"></script>

  <!-- SSH presets (local, optional secrets) -->
  <script type="module">
    const PRESETS_KEY = 'ssh_presets_v1';
    function loadPresets(){
      let items = [];
      try { items = JSON.parse(localStorage.getItem(PRESETS_KEY) || '[]'); } catch {}
      const sel = document.getElementById('sshPresetSelect'); if (!sel) return;
      sel.innerHTML = '';
      if (!items.length){
        const opt = document.createElement('option'); opt.value=''; opt.textContent='No presets'; sel.appendChild(opt);
        return;
      }
      items.forEach(p=>{
        const opt = document.createElement('option');
        opt.value = p.name; opt.textContent = p.name;
        sel.appendChild(opt);
      });
    }
    function getForm(){
      return {
        name: (document.getElementById('sshPresetName')?.value||'').trim(),
        host: (document.getElementById('sshHost')?.value||'').trim(),
        port: Number(document.getElementById('sshPort')?.value||22),
        username: (document.getElementById('sshUsername')?.value||'').trim(),
        authMethod: document.getElementById('authMethod')?.value || 'key',
        password: document.getElementById('sshPassword')?.value || '',
        privateKey: document.getElementById('sshPrivateKey')?.value || '',
        passphrase: document.getElementById('sshPassphrase')?.value || '',
        remotePath: document.getElementById('remotePath')?.value || '/',
        storeSecrets: !!document.getElementById('sshStoreSecrets')?.checked
      };
    }
    function setForm(p){
      if (!p) return;
      const set = (id,val)=>{ const el = document.getElementById(id); if (el!=null) el.value = val ?? el.value; };
      set('sshHost', p.host);
      set('sshPort', p.port);
      set('sshUsername', p.username);
      set('authMethod', p.authMethod);
      document.getElementById('authMethod')?.dispatchEvent(new Event('change',{bubbles:true}));
      if (p.password!=null) set('sshPassword', p.password);
      if (p.privateKey!=null) set('sshPrivateKey', p.privateKey);
      if (p.passphrase!=null) set('sshPassphrase', p.passphrase);
      set('remotePath', p.remotePath);
      set('sshPresetName', p.name);
    }
    function savePreset(){
      const p = getForm();
      if (!p.name){ window.AdvancedCodeEditorAPI?.showNotification('‚ö†Ô∏è Preset name is required','warning'); return; }
      if (!p.host || !p.username){ window.AdvancedCodeEditorAPI?.showNotification('‚ö†Ô∏è Host and Username required','warning'); return; }
      const preset = { name: p.name, host: p.host, port: p.port, username: p.username, authMethod: p.authMethod, remotePath: p.remotePath };
      if (p.storeSecrets){ preset.password = p.password; preset.privateKey = p.privateKey; preset.passphrase = p.passphrase; }
      let items = [];
      try { items = JSON.parse(localStorage.getItem(PRESETS_KEY) || '[]'); } catch {}
      const idx = items.findIndex(x=>x.name===preset.name);
      if (idx>=0) items[idx] = preset; else items.push(preset);
      localStorage.setItem(PRESETS_KEY, JSON.stringify(items));
      loadPresets();
      window.AdvancedCodeEditorAPI?.showNotification('‚úÖ SSH preset saved','success');
    }
    function loadSelectedPreset(){
      const name = document.getElementById('sshPresetSelect')?.value || '';
      if (!name){ window.AdvancedCodeEditorAPI?.showNotification('‚ö†Ô∏è No preset selected','warning'); return; }
      let items = [];
      try { items = JSON.parse(localStorage.getItem(PRESETS_KEY) || '[]'); } catch {}
      const preset = items.find(x=>x.name===name);
      if (!preset){ window.AdvancedCodeEditorAPI?.showNotification('‚ö†Ô∏è Preset not found','warning'); return; }
      setForm(preset);
      window.AdvancedCodeEditorAPI?.showNotification(`üì• Loaded preset: ${name}`,'info');
    }
    function deleteSelectedPreset(){
      const name = document.getElementById('sshPresetSelect')?.value || '';
      if (!name) return;
      let items = [];
      try { items = JSON.parse(localStorage.getItem(PRESETS_KEY) || '[]'); } catch {}
      items = items.filter(x=>x.name!==name);
      localStorage.setItem(PRESETS_KEY, JSON.stringify(items));
      loadPresets();
      window.AdvancedCodeEditorAPI?.showNotification(`üóë Deleted preset: ${name}`,'info');
    }
    window.addEventListener('DOMContentLoaded', ()=>{
      loadPresets();
      document.getElementById('sshSavePresetBtn')?.addEventListener('click', savePreset);
      document.getElementById('sshLoadPresetBtn')?.addEventListener('click', loadSelectedPreset);
      document.getElementById('sshDeletePresetBtn')?.addEventListener('click', deleteSelectedPreset);

      // Auth UI toggle
      const authSel = document.getElementById('authMethod');
      const updateAuth = (val) => {
        const isPassword = val === 'password';
        document.getElementById('passwordGroup')?.classList.toggle('hidden', !isPassword);
        document.getElementById('privateKeyGroup')?.classList.toggle('hidden', isPassword);
        document.getElementById('passphraseGroup')?.classList.toggle('hidden', isPassword);
      };
      authSel?.addEventListener('change', e => updateAuth(e.target.value));
      if (authSel) updateAuth(authSel.value);

      // SSH key file ‚Üí textarea helper
      const keyInput = document.getElementById('sshKeyFile');
      const keyBtn = document.getElementById('sshKeyFileLoadBtn');
      const keyText = document.getElementById('sshPrivateKey');
      const loadKeyToTextarea = (file) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          if (keyText) keyText.value = String(e.target.result || '');
          window.AdvancedCodeEditorAPI?.showNotification(`üîê Loaded key: ${file.name}`, 'success');
        };
        reader.readAsText(file);
      };
      keyInput?.addEventListener('change', (e) => { const f = e.target.files?.[0]; if (f) loadKeyToTextarea(f); });
      keyBtn?.addEventListener('click', () => { if (keyInput?.files?.length) loadKeyToTextarea(keyInput.files[0]); else keyInput?.click(); });
    });
  </script>

  <!-- GitHub Hub integration (no file tree in explorer; open Hub UI instead) -->
  <script type="module">
    import { githubHub, gitHandlers } from './src/services/githubHub.js';

    // Wait for main to be present then wire modal actions
    import('./src/main.js').then(async () => {
      document.addEventListener('click', async (e) => {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        const action = btn.getAttribute('data-action');

        // Open modal: probe hub status
        if (action === 'modal:open' && btn.getAttribute('data-target') === '#githubModal') {
          const statusEl = document.getElementById('githubHubStatus');
          const statusTextEl = document.getElementById('githubHubStatusText');
          const repoEl = document.getElementById('githubHubRepo');
          const localConfig = document.getElementById('githubLocalConfig');
          const hubConfig = document.getElementById('githubHubConfig');
          const executeBtn = document.getElementById('githubExecuteBtn');

          statusTextEl.textContent = 'Checking GitHub Hub...';
          statusEl.classList.remove('connected');

          const config = await githubHub.checkConnection();

          if (githubHub.connected && config) {
            statusEl.classList.add('connected');
            statusTextEl.textContent = 'Connected to GitHub Hub';
            const repoName = config.repo_url.split('/').slice(-2).join('/').replace('.git', '');
            repoEl.textContent = `Repository: ${repoName} (${config.default_branch || 'main'})`;

            localConfig.style.display = 'none';
            hubConfig.style.display = 'block';
            executeBtn.style.display = 'none';

            // Populate branches
            try {
              const branches = await githubHub.getBranches();
              const selector = document.getElementById('branchSelector');
              selector.innerHTML = '';
              branches.branches?.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch;
                option.textContent = branch;
                if (branch === config.default_branch) option.selected = true;
                selector.appendChild(option);
              });
            } catch (err) {
              console.error('Failed to load branches:', err);
            }
          } else {
            statusEl.classList.remove('connected');
            statusTextEl.textContent = 'GitHub Hub not configured';
            repoEl.textContent = 'Configure GitHub Hub first or use local git commands';

            localConfig.style.display = 'block';
            hubConfig.style.display = 'none';
            executeBtn.style.display = 'block';
          }
        }

        // Map enhanced git actions
        if (gitHandlers[action]) {
          e.preventDefault();
          gitHandlers[action]();
        }

        // Hub UI helpers (no GitHub file tree injected into explorer)
        if (action === 'github:open-hub-ui') {
          window.open('/api/github-hub/ui/', '_blank');
          document.querySelector('#githubModal')?.classList.add('hidden');
        }

        if (action === 'github:refresh-branches') {
          try {
            const branches = await githubHub.getBranches();
            const selector = document.getElementById('branchSelector');
            const current = selector.value;
            selector.innerHTML = '';
            branches.branches?.forEach(branch => {
              const option = document.createElement('option');
              option.value = branch;
              option.textContent = branch;
              if (branch === current) option.selected = true;
              selector.appendChild(option);
            });
            window.AdvancedCodeEditorAPI?.showNotification('‚úÖ Branches refreshed', 'success');
          } catch (err) {
            window.AdvancedCodeEditorAPI?.showNotification(`‚ùå Failed to refresh: ${err.message}`, 'error');
          }
        }

        if (action === 'github:switch-mode') {
          window.switchGitMode?.('local');
          document.querySelector('#githubModal')?.classList.add('hidden');
        }
      });
    });
  </script>
</body>
</html>