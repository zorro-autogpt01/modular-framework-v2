version: "3.9"
services:  
  neo4j:
    image: neo4j:5
    environment:
      NEO4J_AUTH=neo4j/password
    ports:
      - "7474:7474"
      - "7687:7687"
    networks:
      codecontext-network
    environment:
      - NEO4J_AUTH=neo4j/password
    networks:
      - codecontext-network
  web:
    build: ./frontend
    image: codecontext-rag-web:latest
    ports:
      - "5173:80"
    depends_on:
      - api
    environment:
      - NODE_ENV=development
      - VITE_API_BASE=http://api:8000
    networks:
      - codecontext-network

  api:
    build: .
    image: codecontext-rag:dev
    ports:
      - "7998:8000"
    environment:
      APP_ENV: development
      GITHUB_HUB_URL: http://192.168.0.10:3002  # Use service name
      GITHUB_HUB_ENABLED: "True"
      GITHUB_DEFAULT_CONN: default
      EMBEDDING_DIMENSION: 1536
      LOG_LEVEL: INFO
      API_KEY_REQUIRED: "false"
      LANCEDB_PATH: /data/lancedb
      INDEX_META_PATH: /data/index_meta
      LLM_GATEWAY_URL: http://192.168.0.10:3010
      CORS_ORIGINS: "http://localhost:3000,http://web:80"
      NEO4J_ENABLED: "True"
      NEO4J_URL: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: password
    volumes:
      - ./:/app
      - lancedb_data:/data/lancedb
      - index_meta:/data/index_meta
    networks:
      - codecontext-network
    command: ["uvicorn", "src.codecontext.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    depends_on:
      - neo4j
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
volumes:
  lancedb_data:
  index_meta:

networks:
  codecontext-network:
    driver: bridge
